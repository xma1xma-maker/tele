<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Clicker Pro V5 - SS34SS4</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0a0a0a;
            --primary: #0098EA;
            --secondary: #f39c12;
            --surface: rgba(255, 255, 255, 0.08);
            --border: rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
            --success: #00E096;
            --danger: #FF3B30;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 0%, #1a3a5a, #000);
            color: var(--text-main);
            margin: 0; min-height: 100vh;
            display: flex; flex-direction: column;
            padding-bottom: 95px;
            overflow-x: hidden;
        }

        /* --- UI Components --- */
        #loader { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #333; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border); z-index: 10; }
        .rank-display { font-size: 0.8rem; font-weight: bold; color: var(--secondary); border: 1px solid var(--secondary); padding: 4px 8px; border-radius: 10px; }

        .score-container { text-align: center; margin-top: 15px; }
        .score-val { font-size: 2.8rem; font-weight: 900; color: #fff; text-shadow: 0 0 15px rgba(0, 152, 234, 0.5); }

        .game-area { flex-grow: 1; display: flex; align-items: center; justify-content: center; position: relative; }
        .coin { width: 220px; height: 220px; border-radius: 50%; border: 8px solid rgba(255,255,255,0.1); box-shadow: 0 0 50px rgba(0, 152, 234, 0.4); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.1s; background: radial-gradient(circle at 30% 30%, #4facfe, #00f2fe); }
        .coin:active { transform: scale(0.92); }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 1000; display: none; align-items: flex-end; backdrop-filter: blur(5px); }
        .modal-overlay.active { display: flex; }
        .modal-content { background: #151515; width: 100%; border-radius: 30px 30px 0 0; padding: 25px; border-top: 2px solid var(--primary); max-height: 80vh; overflow-y: auto; }
        
        .btn-main { width: 100%; padding: 15px; background: var(--primary); border: none; color: #fff; border-radius: 12px; font-weight: bold; margin-top: 10px; cursor: pointer; }
        .nav-bar { position: fixed; bottom: 15px; left: 15px; right: 15px; background: rgba(20,20,20,0.9); border-radius: 20px; display: flex; justify-content: space-around; padding: 10px; border: 1px solid var(--border); }
        .nav-btn { display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; color: #888; cursor: pointer; }
        .nav-btn.active { color: #fff; }

        .list-item { background: var(--surface); padding: 15px; border-radius: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border); }
        .float-num { position: fixed; color: #fff; font-weight: 900; font-size: 2rem; pointer-events: none; z-index: 100; text-shadow: 0 0 5px var(--primary); animation: floatUp 0.8s forwards; }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-80px); } }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <h3 style="margin-top:15px">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</h3>
    </div>

    <div class="header">
        <button style="background:none; border:none; font-size:1.5rem; cursor:pointer" onclick="toggleLang()">ğŸŒ</button>
        <span id="rank-name" class="rank-display">Bronze</span>
        <div id="user-display-name" style="font-weight:bold; font-size:0.8rem">...</div>
    </div>

    <div class="score-container">
        <div class="score-val" id="score">0</div>
        <div style="color:#888; font-size:0.8rem" data-key="balance">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
    </div>

    <div class="game-area">
        <div class="coin" id="main-coin" onpointerdown="handleTap(event)">
            <svg viewBox="0 0 24 24" width="100" fill="white"><path d="M12 22L1.5 8 12 2l10.5 6L12 22zm0-2.5l8-10-8-5.5-8 5.5 8 10z"/></svg>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-btn active" onclick="closeAllModals()">ğŸ  <span data-key="nav_home">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></div>
        <div class="nav-btn" onclick="openStore()">ğŸ›ï¸ <span data-key="nav_store">Ø§Ù„Ù…ØªØ¬Ø±</span></div>
        <div class="nav-btn" onclick="openTasks()">ğŸ“‹ <span data-key="nav_tasks">Ù…Ù‡Ø§Ù…</span></div>
        <div class="nav-btn" onclick="startQuiz()">ğŸ§  <span data-key="nav_quiz">Ù…Ø³Ø§Ø¨Ù‚Ø©</span></div>
    </div>

    <div class="modal-overlay" id="storeModal">
        <div class="modal-content">
            <h3 style="text-align:center" data-key="nav_store">Ø§Ù„Ù…ØªØ¬Ø±</h3>
            <div id="store-items-list"></div>
            <button class="btn-main" style="background:#333" onclick="closeModal('storeModal')">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <div class="modal-overlay" id="orderModal">
        <div class="modal-content">
            <h3 id="order-item-title" style="text-align:center">Ø·Ù„Ø¨</h3>
            <input type="text" class="inp" id="order-link" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ùˆ Ø§Ù„Ù…Ø¹Ø±Ù" style="width:100%; padding:15px; background:#222; border:1px solid #444; color:#fff; border-radius:12px; margin-bottom:10px; text-align:center;">
            <button class="btn-main" onclick="processOrder()">ØªØ£ÙƒÙŠØ¯ ÙˆØ®ØµÙ… Ø§Ù„Ù†Ù‚Ø§Ø·</button>
        </div>
    </div>

    <div class="modal-overlay" id="tasksModal">
        <div class="modal-content">
            <h3 style="text-align:center" data-key="nav_tasks">Ø§Ù„Ù…Ù‡Ø§Ù…</h3>
            <div id="tasks-list"></div>
            <button class="btn-main" style="background:#333" onclick="closeModal('tasksModal')">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <div class="modal-overlay" id="quizModal">
        <div class="modal-content" style="text-align:center">
            <h3 data-key="nav_quiz">Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</h3>
            <div id="quiz-container"></div>
            <button class="btn-main" style="background:#333" onclick="closeModal('quizModal')">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ
        const firebaseConfig = {
            apiKey: "AIzaSyACixZDVCNww716fRN_29xm2kCnFadkL64",
            authDomain: "tele-ea6e7.firebaseapp.com",
            projectId: "tele-ea6e7",
            storageBucket: "tele-ea6e7.firebasestorage.app",
            messagingSenderId: "693110799024",
            appId: "1:693110799024:web:4dd4057eef17b9ed3e1975",
            measurementId: "G-902LN1FW97"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tg = window.Telegram.WebApp;
        tg.expand();

        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø¯Ù…Ù† Mustafa Alaa
        const CONFIG = {
            adminUsername: "SS34SS4", 
            botLink: "https://t.me/tofe109tofebot" 
        };

        let userId = "guest_user";
        let state = { score: 0, lang: 'ar', completedTasks: [] };
        let currentOrder = null;

        const LANGS = {
            ar: { balance: "Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ", nav_home: "Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", nav_store: "Ø§Ù„Ù…ØªØ¬Ø±", nav_tasks: "Ù…Ù‡Ø§Ù…", nav_quiz: "Ù…Ø³Ø§Ø¨Ù‚Ø©" },
            en: { balance: "Current Balance", nav_home: "Home", nav_store: "Store", nav_tasks: "Tasks", nav_quiz: "Quiz" }
        };

        window.onload = async () => {
            if(tg.initDataUnsafe?.user) {
                userId = tg.initDataUnsafe.user.id.toString();
                document.getElementById('user-display-name').innerText = tg.initDataUnsafe.user.first_name;
            } else {
                document.getElementById('user-display-name').innerText = "Mustafa";
            }

            await loadUserData();
            updateUI();
            document.getElementById('loader').style.display = 'none';
            
            // Ø­Ù„Ù‚Ø© Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
            setInterval(syncPoints, 15000);
        };

        async function loadUserData() {
            try {
                const docRef = doc(db, "players", userId);
                const snap = await getDoc(docRef);
                if(snap.exists()) { state = {...state, ...snap.data()}; }
                else { await setDoc(docRef, state); }
            } catch(e) { console.error("Load Error", e); }
        }

        async function syncPoints() {
            if(!userId) return;
            await setDoc(doc(db, "players", userId), state, {merge:true});
        }

        // --- Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ ---
        window.openStore = async () => {
            document.getElementById('storeModal').classList.add('active');
            const listDiv = document.getElementById('store-items-list');
            listDiv.innerHTML = "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§...";
            
            try {
                const snap = await getDocs(collection(db, "gifts"));
                listDiv.innerHTML = "";
                snap.forEach(docSnap => {
                    const item = docSnap.data();
                    const name = state.lang === 'ar' ? item.name_ar : item.name_en;
                    listDiv.innerHTML += `
                        <div class="list-item" onclick="prepareOrder('${name}', ${item.price})">
                            <span>${item.icon || 'ğŸ'} ${name}</span>
                            <b style="color:var(--secondary)">${item.price.toLocaleString()} P</b>
                        </div>`;
                });
            } catch(e) { listDiv.innerHTML = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„"; }
        };

        window.prepareOrder = (name, price) => {
            currentOrder = { name, price };
            document.getElementById('order-item-title').innerText = name;
            document.getElementById('orderModal').classList.add('active');
        };

        window.processOrder = async () => {
            const link = document.getElementById('order-link').value;
            if(!link) return tg.showAlert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø·!");
            if(state.score < currentOrder.price) return tg.showAlert("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù†Ù‚Ø§Ø·Ùƒ ØºÙŠØ± ÙƒØ§ÙÙŠØ©!");

            state.score -= currentOrder.price;
            updateUI();
            await syncPoints();

            const msg = `ğŸš¨ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…ØªØ¬Ø±:\nğŸ Ø§Ù„Ø®Ø¯Ù…Ø©: ${currentOrder.name}\nğŸ”— Ø§Ù„Ø±Ø§Ø¨Ø·: ${link}\nğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${userId}`;
            tg.openTelegramLink(`https://t.me/${CONFIG.adminUsername}?text=${encodeURIComponent(msg)}`);
            closeAllModals();
            tg.showAlert("ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø·Ù„Ø¨ ÙˆØ®ØµÙ… Ø§Ù„Ù†Ù‚Ø§Ø·!");
        };

        // --- Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© ---
        window.openTasks = async () => {
            document.getElementById('tasksModal').classList.add('active');
            const listDiv = document.getElementById('tasks-list');
            listDiv.innerHTML = "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ù…...";
            
            try {
                const snap = await getDocs(collection(db, "tasks"));
                listDiv.innerHTML = "";
                snap.forEach(docSnap => {
                    const task = docSnap.data();
                    const taskId = docSnap.id;
                    if(state.completedTasks.includes(taskId)) return;

                    const txt = state.lang === 'ar' ? task.txt_ar : task.txt_en;
                    listDiv.innerHTML += `
                        <div class="list-item">
                            <span>${txt} (+${task.r})</span>
                            <button onclick="doTask('${taskId}', '${task.url}', ${task.r})" style="background:var(--primary); color:#fff; border:none; padding:8px 12px; border-radius:10px; cursor:pointer;">GO</button>
                        </div>`;
                });
            } catch(e) { listDiv.innerHTML = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„"; }
        };

        window.doTask = async (id, url, reward) => {
            window.open(url, '_blank');
            state.score += reward;
            state.completedTasks.push(id);
            updateUI();
            await syncPoints();
            tg.showAlert("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø§Ø¦Ø²Ø© Ø¨Ù†Ø¬Ø§Ø­!");
            window.openTasks();
        };

        // --- Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© ---
        window.startQuiz = async () => {
            document.getElementById('quizModal').classList.add('active');
            const quizDiv = document.getElementById('quiz-container');
            quizDiv.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªÙŠØ§Ø± Ø³Ø¤Ø§Ù„...";

            try {
                const snap = await getDocs(collection(db, "quiz"));
                const questions = [];
                snap.forEach(d => questions.push(d.data()));
                
                if(questions.length === 0) return quizDiv.innerHTML = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹";
                const q = questions[Math.floor(Math.random() * questions.length)];
                
                const qTxt = state.lang === 'ar' ? q.q_ar : q.q_en;
                const opts = state.lang === 'ar' ? q.opts_ar : q.opts_en;

                quizDiv.innerHTML = `<p style="margin-bottom:20px; font-weight:bold;">${qTxt}</p>`;
                opts.forEach((opt, i) => {
                    quizDiv.innerHTML += `<button class="btn-main" style="background:#222; margin-top:5px;" onclick="checkAnswer(${i}, ${q.c})">${opt}</button>`;
                });
            } catch(e) { quizDiv.innerHTML = "ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„"; }
        };

        window.checkAnswer = async (sel, corr) => {
            if(sel === corr) {
                state.score += 500;
                await syncPoints();
                updateUI();
                tg.showAlert("Ø±Ø§Ø¦Ø¹! Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© +500 Ù†Ù‚Ø·Ø©.");
                closeModal('quizModal');
            } else {
                tg.showAlert("Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©ØŒ Ø­Ø§ÙˆÙ„ ÙÙŠ Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©!");
            }
        };

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¶ØºØ· ---
        window.handleTap = (e) => {
            state.score += 1;
            updateUI();
            if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
            showFloat(e.clientX, e.clientY, "+1");
        };

        function updateUI() {
            document.getElementById('score').innerText = Math.floor(state.score).toLocaleString();
            applyLangUI();
            updateRank();
        }

        function updateRank() {
            let r = "Bronze", c = "#cd7f32";
            if(state.score > 50000) { r = "Silver"; c = "#aaa"; }
            if(state.score > 500000) { r = "Gold"; c = "#ffd700"; }
            document.getElementById('rank-name').innerText = r;
            document.getElementById('rank-name').style.color = c;
        }

        window.toggleLang = () => {
            state.lang = state.lang === 'ar' ? 'en' : 'ar';
            applyLangUI();
            syncPoints();
        };

        function applyLangUI() {
            const d = LANGS[state.lang];
            document.body.dir = state.lang === 'ar' ? 'rtl' : 'ltr';
            document.querySelectorAll('[data-key]').forEach(el => {
                const key = el.getAttribute('data-key');
                if(d[key]) el.innerText = d[key];
            });
        }

        window.closeModal = (id) => document.getElementById(id).classList.remove('active');
        window.closeAllModals = () => document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));

        function showFloat(x,y,t){
            const e = document.createElement('div'); e.className='float-num'; e.style.left=x+'px'; e.style.top=y+'px'; e.innerText=t;
            document.body.appendChild(e);
            setTimeout(()=>e.remove(), 800);
        }
    </script>
</body>
</html>

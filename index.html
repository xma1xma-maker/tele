'day-box ' + (i < state.streak ? 'claimed' : (i === state.streak && canClaim ? 'claimable' : ''));
                
                const reward = i === 7 ? 1000 : i * 100;
                dayBox.innerHTML = `<span class="day-number">${state.lang === 'ar' ? 'ÙŠÙˆÙ…' : 'Day'} ${i}</span><span class="day-icon">ğŸ</span><span class="day-reward">+${reward}</span>`;
                
                // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø§Ù„Ù†Ù‚Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙŠÙˆÙ… Ù…ØªØ§Ø­Ø§Ù‹
                if (i === state.streak && canClaim) {
                    dayBox.onclick = claimDaily;
                }
                
                streakContainer.appendChild(dayBox);
            }

            const btn = document.getElementById('claim-btn');
            const status = document.getElementById('daily-status');

            if (canClaim) {
                btn.disabled = false;
                btn.style.background = "var(--primary)";
                btn.innerText = state.lang === 'ar' ? "Ø§Ø³ØªÙ„Ø§Ù…" : "Claim";
                status.innerText = state.lang === 'ar' ? "Ù…ÙƒØ§ÙØ£ØªÙƒ Ø¬Ø§Ù‡Ø²Ø©!" : "Reward Ready!";
            } else {
                btn.disabled = true;
                btn.style.background = "#333";
                btn.innerText = state.lang === 'ar' ? "Ø¹Ø¯ ØºØ¯Ø§Ù‹" : "Come Tomorrow";
                status.innerText = state.lang === 'ar' ? "ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… âœ…" : "Claimed âœ…";
            }
        }

        async function claimDaily() {
            const { success, data, message } = await ServerAPI._call('claimDailyReward');
            if (success) {
                state.score = data.score;
                state.streak = data.streak;
                state.lastDailyDate = data.lastDailyDate;
                updateUI();
                openDaily(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù„ØºÙ„Ù‚ Ø§Ù„Ø²Ø±
                tg.showAlert(state.lang === 'ar' ? "ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©!" : "Reward Claimed!");
            } else {
                tg.showAlert(message);
            }
        }

        // --- TASKS SYSTEM ---
        function openTasks() {
            openModal('tasks');
            const list = document.getElementById('task-list');
            list.innerHTML = '';
            
            const activeTasks = TASKS.filter(t => !state.doneTasks.includes(t.id));

            if (activeTasks.length === 0) {
                list.innerHTML = `<div style="text-align:center; color:#555">${state.lang === 'ar' ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ø­Ø§Ù„ÙŠØ§Ù‹' : 'No tasks available'}</div>`;
                return;
            }

            activeTasks.forEach(t => {
                const title = state.lang === 'ar' ? t.t_ar : t.t_en;
                list.innerHTML += `
                <div class="task-row">
                    <div>
                        <div style="font-weight:bold">${title}</div>
                        <div style="font-size:0.8rem; color:var(--success)">+${t.r}</div>
                    </div>
                    <button class="btn" style="width:auto; margin:0; padding:5px 15px; font-size:0.8rem;" onclick="doTask(${t.id}, '${t.u}', ${t.r})">GO</button>
                </div>`;
            });
        }

        async function doTask(id, url, reward) {
            // ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·
            if (url.startsWith('http')) {
                tg.openLink(url);
            } else {
                window.open(url, '_blank');
            }

            // Ø·Ù„Ø¨ Ø§Ù„ØªØ£ÙƒÙŠØ¯
            const confirmMsg = state.lang === 'ar' ? "Ù‡Ù„ Ù‚Ù…Øª Ø¨Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ù…Ù‡Ù…Ø©ØŸ" : "Did you complete the task?";
            tg.showConfirm(confirmMsg, async (ok) => {
                if (ok) {
                    const { success, data, message } = await ServerAPI._call('completeTask', { taskId: id, reward: reward });
                    if (success) {
                        state.score = data.score;
                        state.doneTasks = data.doneTasks;
                        updateUI();
                        openTasks(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©
                        tg.showAlert(state.lang === 'ar' ? "ØªÙ…Øª Ø§Ù„Ù…Ù‡Ù…Ø©!" : "Task Completed!");
                    } else {
                        tg.showAlert(message);
                    }
                }
            });
        }

        // --- UTILITIES & UI ---
        function toggleLang() {
            state.lang = state.lang === 'ar' ? 'en' : 'ar';
            localStorage.setItem('lang', state.lang);
            applyLang(state.lang);
        }

        function applyLang(l) {
            document.body.dir = l === 'ar' ? 'rtl' : 'ltr';
            document.getElementById('lang-btn').innerText = l === 'ar' ? 'ğŸ‡ºğŸ‡¸ EN' : 'ğŸ‡®ğŸ‡¶ AR';
            document.querySelectorAll('[data-key]').forEach(el => {
                const key = el.getAttribute('data-key');
                if (LANG[l][key]) el.innerText = LANG[l][key];
            });
        }

        function updateUI() {
            document.getElementById('score').innerText = state.score.toLocaleString();
            document.getElementById('energy-txt').innerText = `${state.energy}/${state.maxEnergy}`;
            document.getElementById('energy-bar').style.width = `${(state.energy / state.maxEnergy) * 100}%`;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØªØ¨Ø©
            let rank = "Bronze ğŸ¥‰";
            if (state.score > 5000) rank = "Silver ğŸ¥ˆ";
            if (state.score > 20000) rank = "Gold ğŸ¥‡";
            if (state.score > 100000) rank = "Diamond ğŸ’";
            document.getElementById('rank-badge').innerText = rank;
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); if(id === 'tasks') openTasks(); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        
        function floatNum(x, y) {
            const el = document.createElement('div'); el.innerText = '+1';
            el.style.cssText = `position:fixed; left:${x}px; top:${y}px; color:#fff; font-weight:bold; pointer-events:none; z-index:999; text-shadow:0 0 5px var(--primary); animation:fly 0.8s forwards;`;
            document.body.appendChild(el); setTimeout(() => el.remove(), 800);
        }
        
        // CSS Animation for float numbers
        document.head.insertAdjacentHTML("beforeend", `<style>@keyframes fly {to{transform:translateY(-100px);opacity:0}}</style>`);

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Clicker Pro V4 - Mustafa Alaa</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0a0a0a;
            --primary: #0098EA;
            --secondary: #f39c12;
            --surface: rgba(255, 255, 255, 0.08);
            --border: rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
            --success: #00E096;
            --danger: #FF3B30;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 0%, #1a3a5a, #000);
            color: var(--text-main);
            margin: 0; min-height: 100vh;
            display: flex; flex-direction: column;
            padding-bottom: 95px;
            overflow-x: hidden;
        }

        /* --- Header & Rank --- */
        .header {
            padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.2); backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            z-index: 10;
        }
        .rank-display { font-size: 0.8rem; font-weight: bold; color: var(--secondary); border: 1px solid var(--secondary); padding: 4px 8px; border-radius: 10px; }

        /* --- Score --- */
        .score-container { text-align: center; margin-top: 15px; }
        .score-val { font-size: 2.8rem; font-weight: 900; color: #fff; text-shadow: 0 0 15px rgba(0, 152, 234, 0.5); }

        /* --- Game Area --- */
        .game-area { flex-grow: 1; display: flex; align-items: center; justify-content: center; position: relative; }
        .coin {
            width: 240px; height: 240px; border-radius: 50%;
            border: 8px solid rgba(255,255,255,0.1);
            box-shadow: 0 0 50px rgba(0, 152, 234, 0.4);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.1s;
        }
        .coin.skin-gold { background: radial-gradient(circle at 30% 30%, #ffd700, #f39c12); }
        .coin.skin-iraq { background: linear-gradient(135deg, #ce1126, #fff, #000); }
        .coin:active { transform: scale(0.92); }
        
        /* Lucky Coin */
        .lucky-coin { position: absolute; width: 60px; height: 60px; background: gold; border-radius: 50%; z-index: 20; display: flex; align-items: center; justify-content: center; animation: pop 0.5s; cursor: pointer; box-shadow: 0 0 20px #fff; }
        @keyframes pop { from { transform: scale(0); } to { transform: scale(1); } }

        /* --- UI Elements --- */
        .menu-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 10px 20px; }
        .menu-item { background: var(--surface); border-radius: 12px; padding: 10px; text-align: center; font-size: 0.7rem; border: 1px solid var(--border); cursor: pointer; }
        
        .energy-container { width: 85%; margin: 10px auto; }
        .energy-bar { height: 10px; background: rgba(255,255,255,0.1); border-radius: 5px; overflow: hidden; margin-top: 5px; }
        .energy-fill { height: 100%; background: var(--primary); width: 100%; transition: width 0.3s; }

        /* --- Modals --- */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 1000; display: none; align-items: flex-end; backdrop-filter: blur(5px); }
        .modal-overlay.active { display: flex; }
        .modal-content { background: #151515; width: 100%; border-radius: 30px 30px 0 0; padding: 25px; border-top: 2px solid var(--primary); max-height: 80vh; overflow-y: auto; }
        .close-x { float: left; background: #333; border: none; color: #fff; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; }

        .nav-bar { position: fixed; bottom: 15px; left: 15px; right: 15px; background: rgba(20,20,20,0.9); border-radius: 20px; display: flex; justify-content: space-around; padding: 10px; border: 1px solid var(--border); }
        .nav-btn { display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; color: #888; cursor: pointer; }
        .nav-btn.active { color: #fff; }

        .btn-main { width: 100%; padding: 15px; background: var(--primary); border: none; color: #fff; border-radius: 12px; font-weight: bold; margin-top: 15px; cursor: pointer; }
        .inp { width: 100%; padding: 15px; background: #222; border: 1px solid #444; color: #fff; border-radius: 12px; margin-bottom: 10px; text-align: center; }
        
        #loader { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #333; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <h3 style="margin-top:15px">Clicker Pro V4</h3>
    </div>

    <div class="header">
        <div class="user-badge">
            <button style="background:none; border:none; font-size:1.2rem; cursor:pointer" onclick="toggleLang()">ğŸŒ</button>
            <span class="rank-display" id="rank-name">Bronze</span>
        </div>
        <div style="text-align:left">
            <div id="user-display-name" style="font-weight:bold; font-size:0.8rem">...</div>
            <div id="mining-anim" style="font-size:0.6rem; color:#aaa">ğŸ’¤ Idle</div>
        </div>
    </div>

    <div class="score-container">
        <div class="score-val" id="score">0</div>
        <div style="color:#888; font-size:0.8rem" data-key="balance">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
    </div>

    <div class="menu-grid">
        <div class="menu-item" onclick="openModal('minerModal')">â›ï¸ <span data-key="miner">ØªØ¹Ø¯ÙŠÙ†</span></div>
        <div class="menu-item" onclick="openModal('skinsModal')">ğŸ¨ <span data-key="skins">Ø³ÙƒÙ†Ø§Øª</span></div>
        <div class="menu-item" onclick="openModal('friendsModal')">ğŸ‘¥ <span data-key="friends">Ø£ØµØ¯Ù‚Ø§Ø¡</span></div>
        <div class="menu-item" onclick="openModal('boostModal')">ğŸš€ <span data-key="boost">ØªØ±Ù‚ÙŠØ©</span></div>
    </div>

    <div class="game-area" id="game-area">
        <div class="coin" id="main-coin" onpointerdown="handleTap(event)">
            <svg viewBox="0 0 24 24" width="120" fill="white"><path d="M12 22L1.5 8 12 2l10.5 6L12 22zm0-2.5l8-10-8-5.5-8 5.5 8 10z"/></svg>
        </div>
    </div>

    <div class="energy-container">
        <div style="display:flex; justify-content:space-between; font-size:0.8rem">
            <span data-key="energy">Ø§Ù„Ø·Ø§Ù‚Ø©</span>
            <span id="energy-txt">1000/1000</span>
        </div>
        <div class="energy-bar"><div class="energy-fill" id="energy-fill"></div></div>
    </div>

    <div class="nav-bar">
        <div class="nav-btn active" onclick="closeAllModals()">ğŸ  <span data-key="nav_home">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></div>
        <div class="nav-btn" onclick="openModal('storeModal')">ğŸ›ï¸ <span data-key="nav_store">Ø§Ù„Ù…ØªØ¬Ø±</span></div>
        <div class="nav-btn" onclick="openModal('tasksModal')">ğŸ“‹ <span data-key="nav_tasks">Ù…Ù‡Ø§Ù…</span></div>
        <div class="nav-btn" onclick="openModal('quizModal')">ğŸ§  <span data-key="nav_quiz">Ù…Ø³Ø§Ø¨Ù‚Ø©</span></div>
    </div>

    <div class="modal-overlay" id="minerModal">
        <div class="modal-content">
            <button class="close-x" onclick="closeModal('minerModal')">âœ•</button>
            <h3 style="text-align:center" data-key="miner_title">Ø±ÙˆØ¨ÙˆØª Ø§Ù„ØªØ¹Ø¯ÙŠÙ†</h3>
            <div style="text-align:center; font-size:3rem; margin:10px">ğŸ¤–</div>
            <div class="inp" style="background:none; border:none"><span id="miner-rate">0</span> P/Sec</div>
            <button class="btn-main" id="upgrade-miner-btn" onclick="upgradeMiner()">Upgrade</button>
        </div>
    </div>

    <div class="modal-overlay" id="storeModal">
        <div class="modal-content">
            <button class="close-x" onclick="closeModal('storeModal')">âœ•</button>
            <h3 style="text-align:center" data-key="nav_store">Ø§Ù„Ù…ØªØ¬Ø±</h3>
            <div id="store-items-list">
                <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #333" onclick="openOrder('insta', 5000)">
                    <span>ğŸ“¸ Instagram Followers</span> <b>5,000 P</b>
                </div>
                <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #333" onclick="openOrder('tele', 5000)">
                    <span>âœˆï¸ Telegram Members</span> <b>5,000 P</b>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="orderModal">
        <div class="modal-content">
            <button class="close-x" onclick="closeModal('orderModal')">âœ•</button>
            <h3 id="order-item-name" style="text-align:center">Order</h3>
            <input type="text" class="inp" id="order-link-input" placeholder="Link / Username">
            <button class="btn-main" onclick="submitOrder()">Confirm & Deduct</button>
        </div>
    </div>

    <div class="modal-overlay" id="friendsModal">
        <div class="modal-content" style="text-align:center">
            <button class="close-x" onclick="closeModal('friendsModal')">âœ•</button>
            <h3 data-key="friends_title">Invite Friends</h3>
            <div style="font-size:3rem; margin:15px">ğŸ‘¥</div>
            <p style="font-size:0.8rem; color:#aaa">Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ 5,000 Ù†Ù‚Ø·Ø© Ù„ÙƒÙ„ ØµØ¯ÙŠÙ‚ ÙŠØ¯Ø®Ù„ Ù…Ù† Ø±Ø§Ø¨Ø·Ùƒ!</p>
            <input type="text" class="inp" id="ref-link-display" readonly>
            <button class="btn-main" onclick="copyRef()">Copy Link</button>
        </div>
    </div>

    <div class="modal-overlay" id="offlineModal">
        <div class="modal-content" style="text-align:center">
            <h2 style="color:var(--success)">Welcome Back!</h2>
            <p>Ø¬Ù…Ø¹ Ù„Ùƒ Ø§Ù„Ø±ÙˆØ¨ÙˆØª Ø£Ø«Ù†Ø§Ø¡ ØºÙŠØ§Ø¨Ùƒ:</p>
            <h1 id="offline-val" style="color:var(--primary)">0</h1>
            <button class="btn-main" onclick="closeModal('offlineModal')">Claim</button>
        </div>
    </div>

    <div class="modal-overlay" id="skinsModal"><div class="modal-content"><button class="close-x" onclick="closeModal('skinsModal')">âœ•</button><h3>Skins</h3><div id="skins-container"></div></div></div>
    <div class="modal-overlay" id="tasksModal"><div class="modal-content"><button class="close-x" onclick="closeModal('tasksModal')">âœ•</button><h3>Tasks</h3><div id="tasks-container"></div></div></div>
    <div class="modal-overlay" id="quizModal"><div class="modal-content"><button class="close-x" onclick="closeModal('quizModal')">âœ•</button><h3>Quiz</h3><div id="quiz-container"></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyACixZDVCNww716fRN_29xm2kCnFadkL64",
            authDomain: "tele-ea6e7.firebaseapp.com",
            projectId: "tele-ea6e7",
            storageBucket: "tele-ea6e7.firebasestorage.app",
            messagingSenderId: "693110799024",
            appId: "1:693110799024:web:4dd4057eef17b9ed3e1975",
            measurementId: "G-902LN1FW97"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tg = window.Telegram.WebApp;
        tg.expand();

        // Mustafa Alaa Config
        const CONFIG = {
            adminUsername: "SS34SS4", 
            botLink: "https://t.me/tofe109tofebot", // Update this
            maxEnergy: 1000
        };

        let userId = "test_user";
        let isLoaded = false;
        let hasChanges = false;
        let state = {
            score: 0, energy: 1000, multitap: 1, minerLvl: 0,
            lastLogin: Date.now(), skin: 'default', ownedSkins: ['default'],
            lang: 'ar', refBy: null
        };

        const LANGS = {
            ar: { balance: "Ø§Ù„Ø±ØµÙŠØ¯", energy: "Ø§Ù„Ø·Ø§Ù‚Ø©", miner: "ØªØ¹Ø¯ÙŠÙ†", skins: "Ø³ÙƒÙ†Ø§Øª", friends: "Ø£ØµØ¯Ù‚Ø§Ø¡", boost: "ØªØ±Ù‚ÙŠØ©", nav_home: "Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", nav_store: "Ø§Ù„Ù…ØªØ¬Ø±", nav_tasks: "Ù…Ù‡Ø§Ù…", nav_quiz: "Ù…Ø³Ø§Ø¨Ù‚Ø©" },
            en: { balance: "Balance", energy: "Energy", miner: "Miner", skins: "Skins", friends: "Friends", boost: "Boost", nav_home: "Home", nav_store: "Store", nav_tasks: "Tasks", nav_quiz: "Quiz" }
        };

        // --- Core ---
        window.onload = async () => {
            if(tg.initDataUnsafe?.user) userId = tg.initDataUnsafe.user.id.toString();
            document.getElementById('user-display-name').innerText = tg.initDataUnsafe?.user?.first_name || "Mustafa";

            await loadData();
            checkRef();
            updateUI();
            
            document.getElementById('loader').style.display = 'none';
            startLoops();
        };

        async function loadData() {
            const docRef = doc(db, "players", userId);
            const snap = await getDoc(docRef);
            if(snap.exists()){
                state = {...state, ...snap.data()};
                if(state.minerLvl > 0){
                    const earned = Math.floor((Date.now() - state.lastLogin)/1000) * state.minerLvl;
                    if(earned > 10){
                        state.score += earned;
                        document.getElementById('offline-val').innerText = earned.toLocaleString();
                        openModal('offlineModal');
                    }
                }
            } else { await saveData(true); }
            isLoaded = true;
        }

        async function saveData(force = false) {
            if(!isLoaded || (!hasChanges && !force)) return;
            state.lastLogin = Date.now();
            await setDoc(doc(db, "players", userId), state, {merge:true});
            hasChanges = false;
        }

        async function checkRef() {
            const param = tg.initDataUnsafe?.start_param;
            if(param && param.startsWith('ref_') && !state.refBy){
                const rId = param.split('_')[1];
                if(rId !== userId){
                    const rRef = doc(db, "players", rId);
                    await updateDoc(rRef, { score: increment(5000) });
                    state.score += 1000;
                    state.refBy = rId;
                    await saveData(true);
                    tg.showAlert("ØªÙ…Øª Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­! +1000");
                }
            }
        }

        function startLoops() {
            setInterval(() => {
                if(state.energy < CONFIG.maxEnergy){
                    state.energy = Math.min(CONFIG.maxEnergy, state.energy + state.multitap);
                    updateEnergy();
                }
                if(state.minerLvl > 0){
                    state.score += state.minerLvl;
                    updateScore();
                    document.getElementById('mining-anim').innerText = "â›ï¸ Mining...";
                    hasChanges = true;
                }
            }, 1000);
            setInterval(() => saveData(), 15000);
        }

        // --- Actions ---
        window.handleTap = (e) => {
            if(state.energy >= 1){
                state.energy--; state.score += state.multitap;
                updateScore(); updateEnergy(); updateRank();
                if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
                showFloat(e.clientX, e.clientY, "+"+state.multitap);
                hasChanges = true;
                if(Math.random() < 0.05) spawnLucky();
            }
        };

        window.upgradeMiner = async () => {
            const cost = 20000 * (state.minerLvl + 1);
            if(state.score >= cost){
                state.score -= cost; state.minerLvl++;
                await saveData(true); updateUI();
                tg.showAlert("Upgraded!");
            } else tg.showAlert("Insufficient points!");
        };

        window.submitOrder = async () => {
            const link = document.getElementById('order-link-input').value;
            if(!link) return;
            if(state.score < window.currentOrder.price) return tg.showAlert("No Points!");
            
            state.score -= window.currentOrder.price;
            await saveData(true); updateUI();
            
            const msg = `Order: ${window.currentOrder.name}\nLink: ${link}\nUser: ${userId}`;
            tg.openTelegramLink(`https://t.me/${CONFIG.adminUsername}?text=${encodeURIComponent(msg)}`);
            closeModal('orderModal');
        };

        // --- Helpers ---
        function updateUI() {
            updateScore(); updateEnergy();
            document.getElementById('miner-rate').innerText = state.minerLvl;
            document.getElementById('ref-link-display').value = `${CONFIG.botLink}?start=ref_${userId}`;
            applyLang();
        }
        function updateScore() { document.getElementById('score').innerText = Math.floor(state.score).toLocaleString(); }
        function updateEnergy() {
            document.getElementById('energy-txt').innerText = `${state.energy}/${CONFIG.maxEnergy}`;
            document.getElementById('energy-fill').style.width = (state.energy/CONFIG.maxEnergy*100)+"%";
        }
        function updateRank() {
            let r="Bronze", c="#cd7f32";
            if(state.score>50000){r="Silver";c="#aaa";}
            if(state.score>500000){r="Gold";c="#ffd700";}
            if(state.score>5000000){r="Diamond";c="#00d2ff";}
            document.getElementById('rank-name').innerText = r;
            document.getElementById('rank-name').style.color = c;
        }

        window.openModal = (id) => document.getElementById(id).classList.add('active');
        window.closeModal = (id) => document.getElementById(id).classList.remove('active');
        window.closeAllModals = () => document.querySelectorAll('.modal-overlay').forEach(m=>m.classList.remove('active'));
        window.toggleLang = () => { state.lang = state.lang==='ar'?'en':'ar'; applyLang(); hasChanges=true; };
        function applyLang() {
            const d = LANGS[state.lang];
            document.body.dir = state.lang==='ar'?'rtl':'ltr';
            document.querySelectorAll('[data-key]').forEach(el => {
                const k = el.getAttribute('data-key'); if(d[k]) el.innerText = d[k];
            });
        }

        window.openOrder = (name, price) => {
            window.currentOrder = {name, price};
            document.getElementById('order-item-name').innerText = name;
            document.getElementById('order-price-lbl')?.innerText = price;
            openModal('orderModal');
        };

        window.copyRef = () => {
            navigator.clipboard.writeText(document.getElementById('ref-link-display').value);
            tg.showAlert("Copied!");
        };

        function showFloat(x,y,t){
            const e = document.createElement('div'); e.className='float-num'; e.innerText=t;
            e.style.left=x+'px'; e.style.top=(y-30)+'px'; e.style.position='fixed'; e.style.color='#fff';
            document.body.appendChild(e);
            setTimeout(()=>e.remove(), 800);
        }

        function spawnLucky(){
            const c = document.createElement('div'); c.className='lucky-coin'; c.innerText='ğŸ€';
            const area = document.getElementById('game-area').getBoundingClientRect();
            c.style.left=(Math.random()*(area.width-60))+'px'; c.style.top=(Math.random()*(area.height-60))+'px';
            c.onpointerdown=(e)=>{ e.stopPropagation(); state.score+=1000; hasChanges=true; updateScore(); c.remove(); };
            document.getElementById('game-area').appendChild(c);
            setTimeout(()=>c.remove(), 1000);
        }

    </script>
</body>
</html>

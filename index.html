<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TON Legend Ultimate V2</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0a0a0a;
            --primary: #0098EA;
            --primary-glow: rgba(0, 152, 234, 0.6);
            --secondary: #f39c12;
            --surface: rgba(255, 255, 255, 0.08);
            --border: rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
            --text-muted: #888;
            --success: #00E096;
            --danger: #FF3B30;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 0%, #1a3a5a, #000);
            color: var(--text-main);
            margin: 0; height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden;
            padding-bottom: 95px;
        }

        /* --- Animations --- */
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-80px) scale(1.5); } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* --- Header --- */
        .header {
            padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.2); backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            z-index: 10;
        }
        .user-badge { display: flex; align-items: center; gap: 10px; }
        .avatar { width: 35px; height: 35px; background: linear-gradient(45deg, var(--primary), #00d2ff); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; }
        .rank-info { display: flex; flex-direction: column; line-height: 1.2; }
        .rank-name { font-weight: 800; font-size: 0.9rem; color: var(--secondary); }
        .rank-bar-bg { width: 80px; height: 4px; background: #333; border-radius: 2px; margin-top: 3px; overflow: hidden; }
        .rank-bar-fill { height: 100%; background: var(--secondary); width: 0%; transition: width 0.5s; }

        /* --- Score --- */
        .score-container { text-align: center; margin-top: 20px; position: relative; }
        .score-val { font-size: 3.5rem; font-weight: 900; background: -webkit-linear-gradient(#fff, #bbb); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 15px rgba(255,255,255,0.3)); }
        .score-label { font-size: 0.9rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }

        /* --- Coin --- */
        .game-stage { flex-grow: 1; display: flex; justify-content: center; align-items: center; perspective: 1000px; position: relative; }
        .coin-wrapper {
            width: 260px; height: 260px;
            border-radius: 50%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.1s ease-out;
            cursor: pointer;
            box-shadow: 0 0 80px rgba(0, 152, 234, 0.2);
        }
        .coin-wrapper:active { transform: scale(0.95) !important; }
        .coin-inner {
            width: 100%; height: 100%; border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #4facfe, #00f2fe);
            border: 10px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; justify-content: center;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.5), 0 10px 20px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .coin-logo { width: 65%; fill: #fff; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.4)); z-index: 2; }
        
        .float-num {
            position: absolute; color: #fff; font-weight: 900; font-size: 2rem;
            pointer-events: none; z-index: 100; text-shadow: 0 0 10px var(--primary);
            animation: floatUp 0.8s forwards;
        }

        /* --- Controls --- */
        .controls-row { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; }
        .mini-btn {
            background: var(--surface); border: 1px solid var(--border);
            padding: 10px 20px; border-radius: 20px; color: #fff;
            display: flex; align-items: center; gap: 8px; font-weight: bold;
            font-size: 0.9rem; transition: 0.2s; cursor: pointer;
        }
        .mini-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.15); }

        /* --- Energy --- */
        .energy-container {
            margin: 0 25px 20px 25px;
            background: rgba(0,0,0,0.3); padding: 10px 15px;
            border-radius: 20px; border: 1px solid var(--border);
            backdrop-filter: blur(5px);
        }
        .energy-info { display: flex; justify-content: space-between; font-size: 0.85rem; font-weight: bold; margin-bottom: 8px; }
        .energy-track { height: 12px; background: rgba(255,255,255,0.05); border-radius: 6px; overflow: hidden; }
        .energy-fill { height: 100%; background: linear-gradient(90deg, #ffd700, #f39c12); width: 100%; transition: width 0.2s linear; }

        /* --- Bottom Nav --- */
        .nav-bar {
            position: fixed; bottom: 15px; left: 15px; right: 15px;
            background: rgba(30, 30, 30, 0.9); backdrop-filter: blur(20px);
            border-radius: 25px; border: 1px solid rgba(255,255,255,0.08);
            display: flex; justify-content: space-around;
            padding: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 500;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #888; font-size: 0.75rem; gap: 4px; padding: 5px 10px;
            border-radius: 15px; transition: 0.2s; width: 60px; cursor: pointer;
        }
        .nav-item.active { background: rgba(255,255,255,0.1); color: #fff; transform: translateY(-5px); }
        .nav-icon { font-size: 1.4rem; }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 900;
            opacity: 0; visibility: hidden; transition: 0.3s;
            backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: flex-end;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        
        .modal-content {
            background: #1a1a1a; width: 100%; max-width: 600px;
            border-radius: 30px 30px 0 0;
            padding: 25px;
            transform: translateY(100%); transition: 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            max-height: 80vh; overflow-y: auto;
            border-top: 1px solid var(--border);
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
        }
        .modal-overlay.active .modal-content { transform: translateY(0); }

        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 1.4rem; font-weight: 800; color: #fff; }
        .close-btn { background: #333; border: none; width: 30px; height: 30px; border-radius: 50%; color: #fff; font-weight: bold; cursor: pointer; }

        /* --- List Items (Shop/Tasks) --- */
        .list-item {
            background: rgba(255,255,255,0.05); padding: 15px; border-radius: 15px;
            margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between;
            border: 1px solid transparent; transition: 0.2s;
        }
        .list-item:active { background: rgba(255,255,255,0.1); transform: scale(0.98); }
        .list-icon { font-size: 1.5rem; width: 45px; height: 45px; background: rgba(0,0,0,0.3); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-left: 10px; }
        
        /* Task Buttons */
        .action-btn { padding: 8px 15px; border-radius: 10px; font-weight: bold; border: none; cursor: pointer; font-size: 0.9rem; color: #fff; }
        .btn-go { background: var(--primary); }
        .btn-claim { background: var(--success); animation: pulse 1s infinite; }
        .btn-done { background: #333; color: #888; cursor: default; }

        /* Quiz Options */
        .quiz-opt {
            background: #252525; padding: 15px; border-radius: 12px; margin-bottom: 10px;
            cursor: pointer; border: 1px solid #333; text-align: center; font-size: 1.1rem;
        }
        .quiz-opt.correct { background: var(--success); color: #000; border-color: var(--success); }
        .quiz-opt.wrong { background: var(--danger); border-color: var(--danger); }

        /* Countdown */
        .countdown-box {
            font-size: 2.5rem; font-weight: 900; color: var(--text-main); font-variant-numeric: tabular-nums;
            margin: 20px 0; text-shadow: 0 0 10px rgba(255,255,255,0.2);
        }

        /* Loader */
        #loader { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; transition: opacity 0.5s; }
        .loader-ring { width: 50px; height: 50px; border: 4px solid #333; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div id="loader">
        <div class="loader-ring"></div>
        <h3 style="color:#fff;">TON LEGEND</h3>
    </div>

    <div class="header">
        <div class="user-badge">
            <div class="avatar">üë§</div>
            <div class="rank-info">
                <span class="rank-name" id="rank-name">Bronze</span>
                <div class="rank-bar-bg"><div class="rank-bar-fill" id="rank-bar"></div></div>
            </div>
        </div>
        <button class="mini-btn" onclick="toggleLang()">
            <span id="lang-icon">üá∫üá∏</span> <span id="lang-text">EN</span>
        </button>
    </div>

    <div class="score-container">
        <div class="score-val" id="score">0</div>
        <div class="score-label" data-key="balance">Total Balance</div>
    </div>

    <div class="controls-row" style="margin-top: 20px;">
        <div class="mini-btn" onclick="openDailyModal()">
            <span>üìÖ</span> <span data-key="daily">Daily</span>
        </div>
        <div class="mini-btn" onclick="openModal('code')">
            <span>üéÅ</span> <span data-key="gift">Code</span>
        </div>
    </div>

    <div class="game-stage">
        <div class="coin-wrapper" id="coin" onpointerdown="handleTap(event)">
            <div class="coin-inner">
                <svg class="coin-logo" viewBox="0 0 24 24"><path d="M12 22L1.5 8 12 2l10.5 6L12 22zm0-2.5l8-10-8-5.5-8 5.5 8 10z"/></svg>
            </div>
        </div>
    </div>

    <div class="energy-container">
        <div class="energy-info">
            <span style="color:#f39c12">‚ö° <span data-key="energy">Energy</span></span>
            <span id="energy-txt">1000/1000</span>
        </div>
        <div class="energy-track"><div class="energy-fill" id="energy-bar"></div></div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="switchTab('game')">
            <span class="nav-icon">üéÆ</span> <span data-key="game_tab">Game</span>
        </div>
        <div class="nav-item" onclick="openModal('boost')">
            <span class="nav-icon">üöÄ</span> <span data-key="boost_tab">Boost</span>
        </div>
        <div class="nav-item" onclick="openTasksModal()">
            <span class="nav-icon">üìã</span> <span data-key="tasks_tab">Tasks</span>
        </div>
        <div class="nav-item" onclick="startQuiz()">
            <span class="nav-icon">üß†</span> <span data-key="quiz_tab">Quiz</span>
        </div>
    </div>

    <div class="modal-overlay" id="boost">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title" data-key="boost_title">Boosters</span>
                <button class="close-btn" onclick="closeModal('boost')">‚úï</button>
            </div>
            <div class="list-item" onclick="upgrade('multitap')">
                <div style="display:flex;align-items:center">
                    <div class="list-icon">üëÜ</div>
                    <div style="margin-right:10px">
                        <h4 style="margin:0" data-key="multitap">Multitap</h4>
                        <p style="margin:5px 0 0;color:#aaa;font-size:0.8rem" id="multitap-lvl">Lvl 1</p>
                    </div>
                </div>
                <div class="action-btn btn-go" id="multitap-price">500</div>
            </div>
            <div class="list-item" onclick="upgrade('limit')">
                <div style="display:flex;align-items:center">
                    <div class="list-icon">üîã</div>
                    <div style="margin-right:10px">
                        <h4 style="margin:0" data-key="energy_limit">Limit</h4>
                        <p style="margin:5px 0 0;color:#aaa;font-size:0.8rem" id="limit-lvl">Lvl 1</p>
                    </div>
                </div>
                <div class="action-btn btn-go" id="limit-price">1000</div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="daily">
        <div class="modal-content" style="text-align:center">
            <div class="modal-header">
                <span class="modal-title" data-key="daily_reward">Daily Reward</span>
                <button class="close-btn" onclick="closeModal('daily')">‚úï</button>
            </div>

            <div style="font-size:3rem; margin:10px 0 20px 0">üéÅ</div>
            
            <div id="daily-ready-area">
                <p style="color:#aaa; margin-bottom:20px" data-key="daily_desc">Claim your free points now!</p>
                <button class="mini-btn" style="width:100%; justify-content:center; background:var(--success); padding:15px; font-size:1.1rem" onclick="claimDaily()">
                    <span data-key="claim">Claim</span> (+1000)
                </button>
            </div>

            <div id="daily-timer-area" style="display:none;">
                <p style="color:#aaa;" data-key="next_reward">Next reward in:</p>
                <div class="countdown-box" id="daily-countdown">00:00:00</div>
                <button class="mini-btn" style="width:100%; justify-content:center; background:#333; padding:15px; margin-top:15px" onclick="closeModal('daily')">
                    <span data-key="close_btn">Close</span>
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="tasks">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title" data-key="tasks_title">Tasks</span>
                <button class="close-btn" onclick="closeModal('tasks')">‚úï</button>
            </div>
            <div id="tasks-list-container">
                </div>
        </div>
    </div>

    <div class="modal-overlay" id="quiz">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title" data-key="quiz_title">Quiz</span>
                <button class="close-btn" onclick="closeModal('quiz')">‚úï</button>
            </div>
            
            <div style="background:#333; height:6px; border-radius:3px; margin-bottom:15px; overflow:hidden">
                <div id="quiz-bar" style="width:0%; height:100%; background:var(--primary); transition:0.3s"></div>
            </div>

            <div id="quiz-game-area" style="text-align:center">
                <h2 id="q-txt" style="margin-bottom:25px; line-height:1.4">Question?</h2>
                <div id="q-opts"></div>
            </div>

            <div id="quiz-done-area" style="text-align:center; display:none;">
                <h1>üéâ</h1>
                <h2 data-key="quiz_done">Complete!</h2>
                <p style="color:#aaa" id="quiz-score-res">Score: 0</p>
                <button class="mini-btn" style="width:100%; justify-content:center; background:var(--primary); margin-top:20px" onclick="closeModal('quiz')">OK</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="code">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">Promo Code</span>
                <button class="close-btn" onclick="closeModal('code')">‚úï</button>
            </div>
            <input type="text" id="promo-input" placeholder="Code..." style="width:100%; padding:15px; background:#222; border:1px solid #444; color:#fff; border-radius:12px; margin-bottom:15px; text-align:center">
            <button class="mini-btn" style="width:100%; justify-content:center; background:var(--success)" onclick="redeemCode()">Submit</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // --- Data ---
        const QUESTIONS = [
            { q_ar: "ŸÖÿß ŸáŸä ÿπÿßÿµŸÖÿ© ÿßŸÑÿπÿ±ÿßŸÇÿü", q_en: "Capital of Iraq?", opts_ar: ["ÿ®ÿ∫ÿØÿßÿØ", "ÿßŸÑÿ®ÿµÿ±ÿ©", "ÿ£ÿ±ÿ®ŸäŸÑ"], opts_en: ["Baghdad", "Basra", "Erbil"], c: 0 },
            { q_ar: "ŸÉŸÖ ÿπÿØÿØ ÿ£ŸÑŸàÿßŸÜ ŸÇŸàÿ≥ ŸÇÿ≤ÿ≠ÿü", q_en: "Colors in a rainbow?", opts_ar: ["5", "7", "10"], opts_en: ["5", "7", "10"], c: 1 },
            { q_ar: "ÿ£ÿ≥ÿ±ÿπ ÿ≠ŸäŸàÿßŸÜ ÿ®ÿ±Ÿäÿü", q_en: "Fastest land animal?", opts_ar: ["ÿßŸÑÿ£ÿ≥ÿØ", "ÿßŸÑŸÜŸÖÿ±", "ÿßŸÑŸÅŸáÿØ"], opts_en: ["Lion", "Tiger", "Cheetah"], c: 2 },
            { q_ar: "ÿπŸÖŸÑÿ© ÿßŸÑÿ®Ÿäÿ™ŸÉŸàŸäŸÜ ÿ±ŸÇŸÖŸäÿ©ÿü", q_en: "Is Bitcoin digital?", opts_ar: ["ŸÜÿπŸÖ", "ŸÑÿß"], opts_en: ["Yes", "No"], c: 0 },
            { q_ar: "ŸÖŸÜ ŸáŸà ŸÖÿ§ÿ≥ÿ≥ ÿ™ŸÑŸäÿ¨ÿ±ÿßŸÖÿü", q_en: "Founder of Telegram?", opts_ar: ["ÿßŸäŸÑŸàŸÜ ŸÖÿßÿ≥ŸÉ", "ÿ®ÿßŸÅŸÑ ÿØŸàÿ±ŸàŸÅ", "ÿ≤ŸàŸÉÿ±ÿ®Ÿäÿ±ÿ∫"], opts_en: ["Elon", "Pavel Durov", "Zuck"], c: 1 }
        ];

        const TASKS_DATA = [
            { id: "t_tg_join", icon: "üì¢", ar: "ÿßÿ¥ÿ™ÿ±ŸÉ ŸÅŸä ÿßŸÑŸÇŸÜÿßÿ©", en: "Join Channel", r: 500, url: "https://t.me/telegram" },
            { id: "t_inst_follow", icon: "üì∏", ar: "ÿ™ÿßÿ®ÿπŸÜÿß ÿπŸÑŸâ ÿßŸÜÿ≥ÿ™ŸÇÿ±ÿßŸÖ", en: "Follow Instagram", r: 300, url: "https://instagram.com" },
            { id: "t_x_follow", icon: "üê¶", ar: "ÿ™ÿßÿ®ÿπŸÜÿß ÿπŸÑŸâ X", en: "Follow on X", r: 300, url: "https://twitter.com" },
            { id: "t_yt_sub", icon: "üì∫", ar: "ÿßÿ¥ÿ™ÿ±ŸÉ ŸÅŸä ŸäŸàÿ™ŸäŸàÿ®", en: "Subscribe YouTube", r: 400, url: "https://youtube.com" }
        ];

        // --- Config & State ---
        const CONFIG = {
            baseEnergy: 1000,
            baseCost: { multitap: 500, limit: 1000, speed: 2000 },
            dailyCooldown: 24 * 60 * 60 * 1000 
        };

        let state = {
            score: parseInt(localStorage.getItem('tl_score') || 0),
            energy: parseInt(localStorage.getItem('tl_energy') || 1000),
            upgrades: JSON.parse(localStorage.getItem('tl_upgrades') || '{"multitap":1, "limit":1, "speed":1}'),
            lastDaily: parseInt(localStorage.getItem('tl_lastDaily') || 0),
            lang: localStorage.getItem('tl_lang') || 'ar',
            completedTasks: JSON.parse(localStorage.getItem('tl_tasks') || "[]"),
            quizIdx: 0
        };

        const LANG = {
            ar: { 
                balance: "ÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑŸÉŸÑŸä", energy: "ÿßŸÑÿ∑ÿßŸÇÿ©", 
                game_tab: "ÿßŸÑŸÑÿπÿ®", boost_tab: "ÿ™ÿπÿ≤Ÿäÿ≤", tasks_tab: "ŸÖŸáÿßŸÖ", quiz_tab: "ŸÖÿ≥ÿßÿ®ŸÇÿ©",
                boost_title: "ŸÖÿ±ŸÉÿ≤ ÿßŸÑÿ™ÿπÿ≤Ÿäÿ≤", multitap: "ŸÜŸÇÿ±ÿ© ŸÖÿ™ÿπÿØÿØÿ©", energy_limit: "ÿ≥ÿπÿ© ÿßŸÑÿ∑ÿßŸÇÿ©",
                tasks_title: "ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸáÿßŸÖ", daily_reward: "ÿßŸÑŸÖŸÉÿßŸÅÿ£ÿ© ÿßŸÑŸäŸàŸÖŸäÿ©", gift: "ŸÉŸàÿØ", daily: "ŸäŸàŸÖŸä",
                claim: "ÿßÿ≥ÿ™ŸÑÿßŸÖ", wait: "ÿßŸÜÿ™ÿ∏ÿ±", next_reward: "ÿßŸÑŸÖŸÉÿßŸÅÿ£ÿ© ÿßŸÑÿ™ÿßŸÑŸäÿ© ÿ®ÿπÿØ:", daily_desc: "ÿßÿ≠ÿµŸÑ ÿπŸÑŸâ ŸÜŸÇÿßÿ∑ ŸÖÿ¨ÿßŸÜŸäÿ© ŸÉŸÑ 24 ÿ≥ÿßÿπÿ©!",
                quiz_title: "ŸÖÿ≥ÿßÿ®ŸÇÿ© ÿ´ŸÇÿßŸÅŸäÿ©", quiz_done: "ÿßŸÜÿ™Ÿáÿ™ ÿßŸÑŸÖÿ≥ÿßÿ®ŸÇÿ©!",
                btn_go: "ŸÜŸÅÿ∞", btn_claim: "ÿ™ÿ≠ŸÇŸÇ", btn_done: "ÿ™ŸÖ",
                close_btn: "ÿ•ÿ∫ŸÑÿßŸÇ"
            },
            en: {
                balance: "Total Balance", energy: "Energy",
                game_tab: "Game", boost_tab: "Boost", tasks_tab: "Tasks", quiz_tab: "Quiz",
                boost_title: "Boost Center", multitap: "Multitap", energy_limit: "Energy Limit",
                tasks_title: "Task List", daily_reward: "Daily Reward", gift: "Code", daily: "Daily",
                claim: "Claim", wait: "Wait", next_reward: "Next reward in:", daily_desc: "Get free points every 24h!",
                quiz_title: "Trivia Quiz", quiz_done: "Quiz Completed!",
                btn_go: "Go", btn_claim: "Check", btn_done: "Done",
                close_btn: "Close"
            }
        };

        let dailyInterval;

        // --- Core Functions ---
        function init() {
            updateUI();
            updateUpgradesUI();
            applyLang(state.lang);
            animateCoinTilt();
            
            // Energy Regen
            setInterval(() => {
                const max = CONFIG.baseEnergy * state.upgrades.limit;
                const rec = state.upgrades.speed;
                if(state.energy < max) {
                    state.energy = Math.min(state.energy + rec, max);
                    updateEnergyUI();
                }
            }, 1000);

            setTimeout(() => document.getElementById('loader').style.opacity = 0, 1000);
            setTimeout(() => document.getElementById('loader').style.display = 'none', 1500);
        }

        function save() {
            localStorage.setItem('tl_score', state.score);
            localStorage.setItem('tl_upgrades', JSON.stringify(state.upgrades));
            localStorage.setItem('tl_tasks', JSON.stringify(state.completedTasks));
            localStorage.setItem('tl_lastDaily', state.lastDaily);
        }

        // --- Daily Reward Logic ---
        function openDailyModal() {
            openModal('daily');
            checkDailyStatus();
            if(dailyInterval) clearInterval(dailyInterval);
            dailyInterval = setInterval(checkDailyStatus, 1000);
        }

        function checkDailyStatus() {
            const now = Date.now();
            const diff = now - state.lastDaily;
            const readyArea = document.getElementById('daily-ready-area');
            const timerArea = document.getElementById('daily-timer-area');

            if(diff >= CONFIG.dailyCooldown) {
                readyArea.style.display = 'block';
                timerArea.style.display = 'none';
            } else {
                readyArea.style.display = 'none';
                timerArea.style.display = 'block';
                
                const remaining = CONFIG.dailyCooldown - diff;
                const hours = Math.floor((remaining % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
                
                document.getElementById('daily-countdown').innerText = 
                    `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
            }
        }

        function pad(n) { return n < 10 ? '0'+n : n; }

        function claimDaily() {
            state.score += 1000;
            state.lastDaily = Date.now();
            save(); updateUI();
            checkDailyStatus();
            tg.showAlert("+1000 Points!");
        }

        // --- Tasks Logic ---
        function openTasksModal() {
            openModal('tasks');
            const list = document.getElementById('tasks-list-container');
            list.innerHTML = '';

            const isAr = state.lang === 'ar';
            const txt_go = isAr ? LANG.ar.btn_go : LANG.en.btn_go;
            const txt_done = isAr ? LANG.ar.btn_done : LANG.en.btn_done;

            TASKS_DATA.forEach(task => {
                const isDone = state.completedTasks.includes(task.id);
                const title = isAr ? task.ar : task.en;
                
                let btnHtml = '';
                if(isDone) {
                    btnHtml = `<button class="action-btn btn-done">${txt_done}</button>`;
                } else {
                    btnHtml = `<button class="action-btn btn-go" id="btn-${task.id}" onclick="clickTask('${task.id}', '${task.url}', ${task.r})">${txt_go}</button>`;
                }

                list.innerHTML += `
                    <div class="list-item">
                        <div style="display:flex; align-items:center;">
                            <div class="list-icon">${task.icon}</div>
                            <div style="margin: 0 15px;">
                                <h4 style="margin:0; font-size:0.95rem">${title}</h4>
                                <span style="font-size:0.75rem; color:var(--success)">+${task.r}</span>
                            </div>
                        </div>
                        ${btnHtml}
                    </div>
                `;
            });
        }

        function clickTask(id, url, reward) {
            const btn = document.getElementById(`btn-${id}`);
            const isAr = state.lang === 'ar';
            
            if(btn.classList.contains('btn-go')) {
                window.open(url, '_blank');
                btn.classList.remove('btn-go');
                btn.classList.add('btn-claim');
                btn.innerText = isAr ? LANG.ar.btn_claim : LANG.en.btn_claim;
            } else if (btn.classList.contains('btn-claim')) {
                state.score += reward;
                state.completedTasks.push(id);
                save(); updateUI();
                
                btn.classList.remove('btn-claim');
                btn.classList.add('btn-done');
                btn.innerText = isAr ? LANG.ar.btn_done : LANG.en.btn_done;
                btn.onclick = null;
                tg.showAlert(`+${reward}`);
            }
        }

        // --- Quiz Logic ---
        function startQuiz() {
            openModal('quiz');
            state.quizIdx = 0;
            document.getElementById('quiz-game-area').style.display = 'block';
            document.getElementById('quiz-done-area').style.display = 'none';
            renderQuizQuestion();
        }

        function renderQuizQuestion() {
            if(state.quizIdx >= QUESTIONS.length) {
                document.getElementById('quiz-game-area').style.display = 'none';
                document.getElementById('quiz-done-area').style.display = 'block';
                return;
            }

            const q = QUESTIONS[state.quizIdx];
            const isAr = state.lang === 'ar';
            
            const pct = ((state.quizIdx) / QUESTIONS.length) * 100;
            document.getElementById('quiz-bar').style.width = pct + "%";

            document.getElementById('q-txt').innerText = isAr ? q.q_ar : q.q_en;
            
            const optsDiv = document.getElementById('q-opts');
            optsDiv.innerHTML = '';
            const answers = isAr ? q.opts_ar : q.opts_en;
            
            answers.forEach((ans, i) => {
                const btn = document.createElement('div');
                btn.className = 'quiz-opt';
                btn.innerText = ans;
                btn.onclick = () => handleQuizAnswer(btn, i, q.c);
                optsDiv.appendChild(btn);
            });
        }

        function handleQuizAnswer(btn, selected, correct) {
            if(btn.classList.contains('correct') || btn.classList.contains('wrong')) return;

            const allOpts = document.querySelectorAll('.quiz-opt');
            
            if(selected === correct) {
                btn.classList.add('correct');
                state.score += 100;
                tg.HapticFeedback.impactOccurred('light');
            } else {
                btn.classList.add('wrong');
                allOpts[correct].classList.add('correct');
                tg.HapticFeedback.notificationOccurred('error');
            }
            save(); updateUI();

            setTimeout(() => {
                state.quizIdx++;
                renderQuizQuestion();
            }, 1000);
        }

        // --- Base Game Logic ---
        function handleTap(e) {
            const tapPower = state.upgrades.multitap;
            if(state.energy >= tapPower) {
                state.score += tapPower;
                state.energy -= tapPower;
                updateUI(); updateEnergyUI();
                tg.HapticFeedback.impactOccurred('medium');
                spawnFloatText(e, `+${tapPower}`);
            }
        }

        function spawnFloatText(e, text) {
            const el = document.createElement('div');
            el.className = 'float-num';
            el.innerText = text;
            const x = e.clientX + (Math.random()*40-20);
            const y = e.clientY - 20;
            el.style.left = `${x}px`; el.style.top = `${y}px`;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 800);
        }

        function upgrade(type) {
            const level = state.upgrades[type];
            const cost = CONFIG.baseCost[type] * (2 ** (level - 1));
            if(state.score >= cost) {
                state.score -= cost;
                state.upgrades[type]++;
                save(); updateUI(); updateUpgradesUI();
                tg.showAlert("Upgrade Successful!");
            } else {
                tg.showAlert("Not enough points!");
            }
        }

        function redeemCode() {
            const code = document.getElementById('promo-input').value;
            if(code.toUpperCase() === "TON2024") {
                state.score += 5000;
                save(); updateUI(); closeModal('code');
                tg.showAlert("+5000 Bonus!");
            } else tg.showAlert("Invalid Code");
        }

        // --- UI Updates ---
        function updateUI() {
            document.getElementById('score').innerText = state.score.toLocaleString();
            let rank = "Bronze";
            let progress = 0;
            if(state.score < 5000) { progress = (state.score/5000)*100; }
            else if(state.score < 25000) { rank = "Silver"; progress = ((state.score-5000)/20000)*100; }
            else { rank = "Gold"; progress = 100; }
            document.getElementById('rank-name').innerText = rank;
            document.getElementById('rank-bar').style.width = `${progress}%`;
        }

        function updateEnergyUI() {
            const max = CONFIG.baseEnergy * state.upgrades.limit;
            document.getElementById('energy-txt').innerText = `${Math.floor(state.energy)} / ${max}`;
            document.getElementById('energy-bar').style.width = `${(state.energy/max)*100}%`;
        }

        function updateUpgradesUI() {
            const u = state.upgrades;
            document.getElementById('multitap-lvl').innerText = `Lvl ${u.multitap}`;
            document.getElementById('multitap-price').innerText = (CONFIG.baseCost.multitap * (2**(u.multitap-1))).toLocaleString();
            document.getElementById('limit-lvl').innerText = `Lvl ${u.limit}`;
            document.getElementById('limit-price').innerText = (CONFIG.baseCost.limit * (2**(u.limit-1))).toLocaleString();
        }

        function animateCoinTilt() {
            const coin = document.getElementById('coin');
            const container = document.querySelector('.game-stage');
            container.addEventListener('pointermove', (e) => {
                const rect = container.getBoundingClientRect();
                const x = e.clientX - rect.left - rect.width / 2;
                const y = e.clientY - rect.top - rect.height / 2;
                coin.style.transform = `rotateX(${-y/10}deg) rotateY(${x/10}deg)`;
            });
            container.addEventListener('pointerleave', () => coin.style.transform = `rotateX(0) rotateY(0)`);
        }

        // Lang & Utils
        function toggleLang() {
            state.lang = state.lang === 'ar' ? 'en' : 'ar';
            localStorage.setItem('tl_lang', state.lang);
            applyLang(state.lang);
            if(document.getElementById('tasks').classList.contains('active')) openTasksModal();
            if(document.getElementById('daily').classList.contains('active')) openDailyModal();
            location.reload();
        }

        function applyLang(l) {
            document.body.dir = l === 'ar' ? 'rtl' : 'ltr';
            document.getElementById('lang-text').innerText = l === 'ar' ? 'AR' : 'EN';
            document.querySelectorAll('[data-key]').forEach(el => {
                const k = el.getAttribute('data-key');
                if(LANG[l][k]) el.innerText = LANG[l][k];
            });
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { 
            document.getElementById(id).classList.remove('active'); 
            if(id === 'daily' && dailyInterval) clearInterval(dailyInterval);
        }
        function switchTab(t) {}

        window.onload = init;
    </script>
</body>
</html>

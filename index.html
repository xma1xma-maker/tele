<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Clicker Pro V6.2 - Mustafa Alaa</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0a0a0a;
            --primary: #0098EA;
            --secondary: #f39c12;
            --surface: rgba(255, 255, 255, 0.08);
            --border: rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
            --success: #2ecc71;
            --danger: #e74c3c;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 0%, #1a3a5a, #000);
            color: var(--text-main);
            margin: 0; min-height: 100vh;
            display: flex; flex-direction: column;
            padding-bottom: 95px;
            overflow-x: hidden;
        }

        .header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border); z-index: 10; }
        
        .lang-toggle { 
            background: var(--primary); 
            border: 1px solid var(--border); 
            color: #fff; 
            padding: 6px 15px; 
            border-radius: 20px; 
            cursor: pointer; 
            font-weight: 800; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            font-size: 0.85rem;
            box-shadow: 0 0 10px rgba(0,152,234,0.4);
        }

        .score-container { text-align: center; margin-top: 20px; }
        .score-val { font-size: 3.2rem; font-weight: 900; color: #fff; text-shadow: 0 0 20px var(--primary); }
        .game-area { flex-grow: 1; display: flex; align-items: center; justify-content: center; position: relative; }
        .coin { width: 230px; height: 230px; border-radius: 50%; border: 10px solid rgba(255,255,255,0.1); box-shadow: 0 0 60px rgba(0, 152, 234, 0.4); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.1s; background: radial-gradient(circle at 30% 30%, #4facfe, #00f2fe); }
        .coin:active { transform: scale(0.9); }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; display: none; align-items: flex-end; backdrop-filter: blur(8px); }
        .modal-overlay.active { display: flex; }
        .modal-content { background: #111; width: 100%; border-radius: 30px 30px 0 0; padding: 25px; border-top: 3px solid var(--primary); max-height: 85vh; overflow-y: auto; }
        
        .quiz-option { width: 100%; padding: 15px; margin-bottom: 10px; background: var(--surface); border: 1px solid var(--border); color: #fff; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.3s; text-align: center; }
        .quiz-option.correct { background: var(--success) !important; border-color: #fff; }
        .quiz-option.wrong { background: var(--danger) !important; border-color: #fff; }

        .btn-main { width: 100%; padding: 16px; background: var(--primary); border: none; color: #fff; border-radius: 12px; font-weight: bold; margin-top: 15px; cursor: pointer; box-shadow: 0 4px 15px rgba(0, 152, 234, 0.3); }
        .nav-bar { position: fixed; bottom: 15px; left: 15px; right: 15px; background: rgba(20,20,20,0.95); border-radius: 25px; display: flex; justify-content: space-around; padding: 12px; border: 1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .nav-btn { display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; color: #777; cursor: pointer; transition: 0.2s; }
        .nav-btn.active { color: #fff; transform: translateY(-3px); }

        .float-num { position: fixed; color: #fff; font-weight: 900; font-size: 2.2rem; pointer-events: none; z-index: 100; text-shadow: 0 0 10px var(--primary); animation: floatUp 0.7s forwards; }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-100px); } }
        
        #loader { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .input-field { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: #222; color: #fff; margin: 10px 0; font-family: 'Cairo'; text-align: center; }
        .list-item { background: var(--surface); padding: 12px; border-radius: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

    <div id="loader">
        <div style="width: 50px; height: 50px; border: 5px solid #222; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s infinite linear;"></div>
        <h3 style="margin-top:20px; color: #fff;">Clicker Pro V6.2</h3>
    </div>

    <div class="header">
        <div class="lang-toggle" onclick="toggleLang()">
            <span id="lang-text">EN</span>
            <span id="lang-icon">ğŸŒ</span>
        </div>
        <div style="display: flex; gap: 10px; align-items: center;">
             <button onclick="openModal('friendsModal')" style="background: var(--secondary); border: none; border-radius: 50%; width: 35px; height: 35px; cursor: pointer;">ğŸ‘¥</button>
             <span id="rank-name" style="font-weight:bold; color:var(--secondary); font-size: 0.9rem;">ğŸ¥‰ Bronze</span>
        </div>
        <div id="user-display-name" style="font-weight:bold; font-size:0.8rem">Player</div>
    </div>

    <div class="score-container">
        <div class="score-val" id="score">0</div>
        <div style="color:#666; font-size:0.8rem; letter-spacing: 1px;" data-key="balance">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
    </div>

    <div class="game-area" id="game-area">
        <div class="coin" id="main-coin" onpointerdown="handleTap(event)">
            <svg viewBox="0 0 24 24" width="110" fill="white"><path d="M12 22L1.5 8 12 2l10.5 6L12 22zm0-2.5l8-10-8-5.5-8 5.5 8 10z"/></svg>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-btn active" onclick="closeAllModals()">ğŸ  <span data-key="nav_home">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></div>
        <div class="nav-btn" onclick="openStore()">ğŸ›ï¸ <span data-key="nav_store">Ø§Ù„Ù…ØªØ¬Ø±</span></div>
        <div class="nav-btn" onclick="openTasks()">ğŸ“‹ <span data-key="nav_tasks">Ù…Ù‡Ø§Ù…</span></div>
        <div class="nav-btn" onclick="startQuiz()">ğŸ§  <span data-key="nav_quiz">Ù…Ø³Ø§Ø¨Ù‚Ø©</span></div>
        <div class="nav-btn" onclick="openModal('friendsModal')">ğŸ¤ <span data-key="friends_title">Ø¥Ø­Ø§Ù„Ø©</span></div>
    </div>

    <div class="modal-overlay" id="quizModal">
        <div class="modal-content">
            <h3 style="text-align:center" data-key="nav_quiz">Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</h3>
            <div id="quiz-container" style="text-align:center; padding: 20px 0;"></div>
            <button class="btn-main" style="background:#222" onclick="closeModal('quizModal')">Ø®Ø±ÙˆØ¬</button>
        </div>
    </div>

    <div class="modal-overlay" id="friendsModal">
        <div class="modal-content" style="text-align:center">
            <h3 data-key="friends_title">Ø¯Ø¹ÙˆØ© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</h3>
            <div style="background: rgba(0, 152, 234, 0.1); border: 1px dashed var(--primary); padding: 15px; border-radius: 10px; margin-bottom: 15px; font-weight: bold; color: var(--primary);">
                ğŸ¤ Ø¥Ø­Ø§Ù„Ø§ØªÙƒ: <span id="invite-count">0</span>
            </div>
            <p style="color:#888; font-size:0.9rem;" id="ref-desc">Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ +5,000 Ù†Ù‚Ø·Ø© Ù„ÙƒÙ„ ØµØ¯ÙŠÙ‚ ÙŠØ¯Ø®Ù„ Ù…Ù† Ø±Ø§Ø¨Ø·Ùƒ!</p>
            <input type="text" id="ref-link-display" readonly style="width:100%; padding:15px; background:#1a1a1a; border:1px solid #333; color:var(--primary); border-radius:12px; margin: 15px 0; text-align:center; font-size: 0.8rem;">
            <button class="btn-main" onclick="copyRef()">Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø©</button>
            <button class="btn-main" style="background:#222" onclick="closeModal('friendsModal')">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyACixZDVCNww716fRN_29xm2kCnFadkL64",
            authDomain: "tele-ea6e7.firebaseapp.com",
            projectId: "tele-ea6e7",
            storageBucket: "tele-ea6e7.firebasestorage.app",
            messagingSenderId: "693110799024",
            appId: "1:693110799024:web:4dd4057eef17b9ed3e1975"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tg = window.Telegram.WebApp;
        tg.expand();

        const CONFIG = { adminUsername: "SS34SS4", botLink: "https://t.me/tofe109tofebot" };
        let userId = "mustafa_user";
        let state = { score: 0, lang: 'ar', completedTasks: [], inviteCount: 0, referredBy: null };

        window.onload = async () => {
            if(tg.initDataUnsafe?.user) userId = tg.initDataUnsafe.user.id.toString();
            document.getElementById('user-display-name').innerText = tg.initDataUnsafe?.user?.first_name || "Mustafa";

            await loadUserData();
            // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ù„Ø¶Ù…Ø§Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø·ÙŠØ§Øª Ù…Ù† ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ø¨Ø´ÙƒÙ„ ÙƒØ§Ù…Ù„
            setTimeout(async () => {
                await processReferral();
                updateUI();
            }, 1000);
            
            document.getElementById('loader').style.display = 'none';
        };

        async function loadUserData() {
            const docRef = doc(db, "players", userId);
            const snap = await getDoc(docRef);
            if(snap.exists()) state = {...state, ...snap.data()};
            else await setDoc(docRef, state);
        }

        async function syncPoints() {
            await setDoc(doc(db, "players", userId), state, {merge:true});
        }

        async function processReferral() {
            const urlParams = new URLSearchParams(window.location.search);
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ù…Ø¨Ø§Ø´Ø±Ø© Ø£Ùˆ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
            const startParam = tg.initDataUnsafe?.start_param || urlParams.get('tgWebAppStartParam') || urlParams.get('start');
            
            if (startParam && startParam.startsWith('ref_') && !state.referredBy) {
                const referrerId = startParam.replace('ref_', '');
                
                if (referrerId !== userId) {
                    try {
                        const referrerRef = doc(db, "players", referrerId);
                        const referrerSnap = await getDoc(referrerRef);

                        if (referrerSnap.exists()) {
                            // Ø¥Ø¶Ø§ÙØ© Ù…ÙƒØ§ÙØ£Ø© Ù„Ù„Ø¯Ø§Ø¹ÙŠ
                            await updateDoc(referrerRef, {
                                score: increment(5000),
                                inviteCount: increment(1)
                            });
                            
                            // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙˆØ¥Ø¶Ø§ÙØ© Ù…ÙƒØ§ÙØ£Ø© Ù„Ù‡
                            state.referredBy = referrerId;
                            state.score += 1000; 
                            await syncPoints();
                            tg.showAlert("âœ… ØªÙ…Øª Ø§Ù„Ø¥Ø­Ø§Ù„Ø©! Ø­ØµÙ„Øª Ø£Ù†Øª ÙˆØµØ¯ÙŠÙ‚Ùƒ Ø¹Ù„Ù‰ Ù…ÙƒØ§ÙØ£Ø©.");
                        }
                    } catch (e) {
                        console.error("Referral Error:", e);
                    }
                }
            }
        }

        window.copyRef = () => {
            const link = `${CONFIG.botLink}?start=ref_${userId}`;
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆØ§Ø¬Ù‡Ø© ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ù„Ù„Ù†Ø³Ø® Ø¥Ø°Ø§ ØªÙˆÙØ±ØªØŒ ÙˆØ¥Ù„Ø§ Ø§Ù„Ù…ØªØµÙØ­
            if (navigator.clipboard) {
                navigator.clipboard.writeText(link).then(() => {
                    tg.showAlert(state.lang === 'ar' ? "ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·!" : "Link Copied!");
                });
            } else {
                tg.showAlert("ÙŠØ±Ø¬Ù‰ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠØ¯ÙˆÙŠØ§Ù‹: " + link);
            }
        };

        // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ (Quiz, Tap, UI...) Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± ÙÙŠ Ø§Ù„Ù…Ù†Ø·Ù‚
        window.startQuiz = async () => {
            openModal('quizModal');
            const quizDiv = document.getElementById('quiz-container');
            quizDiv.innerHTML = "ğŸŒ€ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø³Ø¤Ø§Ù„...";
            const snap = await getDocs(collection(db, "quiz"));
            const questions = [];
            snap.forEach(d => questions.push(d.data()));
            if(questions.length === 0) return quizDiv.innerHTML = "âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø©.";
            const q = questions[Math.floor(Math.random() * questions.length)];
            quizDiv.innerHTML = `<h2 style="margin-bottom:20px;">${state.lang === 'ar' ? q.q_ar : q.q_en}</h2>`;
            const options = state.lang === 'ar' ? q.opts_ar : q.opts_en;
            options.forEach((opt, i) => {
                const btn = document.createElement('div');
                btn.className = 'quiz-option';
                btn.innerText = opt;
                btn.onclick = () => checkAnswer(btn, i, q.c);
                quizDiv.appendChild(btn);
            });
        };

        async function checkAnswer(btn, selected, correct) {
            const allOptions = document.querySelectorAll('.quiz-option');
            allOptions.forEach(opt => opt.style.pointerEvents = 'none');
            if(selected === correct) {
                btn.classList.add('correct');
                state.score += 500;
                tg.HapticFeedback.notificationOccurred('success');
            } else {
                btn.classList.add('wrong');
                allOptions[correct].classList.add('correct');
                state.score = Math.max(0, state.score - 200); 
                tg.HapticFeedback.notificationOccurred('error');
            }
            updateUI(); await syncPoints();
            setTimeout(() => window.startQuiz(), 1500);
        }

        window.toggleLang = () => {
            state.lang = state.lang === 'ar' ? 'en' : 'ar';
            updateUI(); syncPoints();
        };

        window.handleTap = (e) => {
            state.score += 1;
            updateUI();
            showFloat(e.clientX, e.clientY, "+1");
            if(state.score % 25 === 0) syncPoints();
        };

        function updateUI() {
            document.getElementById('score').innerText = state.score.toLocaleString();
            document.body.dir = state.lang === 'ar' ? 'rtl' : 'ltr';
            document.getElementById('lang-text').innerText = state.lang === 'ar' ? 'EN' : 'AR';
            document.getElementById('invite-count').innerText = state.inviteCount || 0;
            document.getElementById('ref-link-display').value = `${CONFIG.botLink}?start=ref_${userId}`;
            const keys = {
                balance: state.lang === 'ar' ? "Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ" : "TOTAL BALANCE",
                nav_home: state.lang === 'ar' ? "Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©" : "Home",
                nav_store: state.lang === 'ar' ? "Ø§Ù„Ù…ØªØ¬Ø±" : "Store",
                nav_tasks: state.lang === 'ar' ? "Ù…Ù‡Ø§Ù…" : "Tasks",
                nav_quiz: state.lang === 'ar' ? "Ù…Ø³Ø§Ø¨Ù‚Ø©" : "Quiz",
                friends_title: state.lang === 'ar' ? "Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø­Ø§Ù„Ø©" : "Referral",
            };
            document.querySelectorAll('[data-key]').forEach(el => {
                const k = el.getAttribute('data-key');
                if(keys[k]) el.innerText = keys[k];
            });
            document.getElementById('ref-desc').innerText = state.lang === 'ar' ? "+5,000 Ù†Ù‚Ø·Ø© Ù„ÙƒÙ„ ØµØ¯ÙŠÙ‚ ÙŠØ¯Ø®Ù„ Ù…Ù† Ø±Ø§Ø¨Ø·Ùƒ!" : "+5,000 Points for every friend you invite!";
        }

        window.openModal = (id) => document.getElementById(id).classList.add('active');
        window.closeModal = (id) => document.getElementById(id).classList.remove('active');
        window.closeAllModals = () => document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
        function showFloat(x,y,t){
            const e = document.createElement('div'); e.className='float-num'; e.style.left=x+'px'; e.style.top=y+'px'; e.innerText=t; document.body.appendChild(e);
            setTimeout(()=>e.remove(), 700);
        }
    </script>
</body>
</html>

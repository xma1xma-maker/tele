<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TON Legend V17 - Backend Ready</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #050505; --panel: #1a1a1a; --primary: #0098EA; --gold: #FFD700;
            --success: #2ecc71; --danger: #e74c3c; --text: #ffffff;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        body {
            font-family: 'Cairo', sans-serif; background-color: var(--bg ); color: var(--text); margin: 0; height: 100vh;
            display: flex; flex-direction: column; overflow: hidden;
            background-image: radial-gradient(circle at 50% 10%, #1a2a3a, #000); padding-bottom: 90px;
        }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s; }
        .spinner { width: 50px; height: 50px; border: 5px solid #333; border-top: 5px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .header { padding: 15px; display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.03); border-bottom: 1px solid rgba(255,255,255,0.05); }
        .user-info { display: flex; gap: 10px; align-items: center; }
        .rank-badge { background: var(--gold); color: #000; padding: 3px 10px; border-radius: 10px; font-weight: bold; font-size: 0.8rem; }
        .lang-btn { background: transparent; border: 1px solid var(--primary); color: var(--primary); padding: 5px 12px; border-radius: 15px; cursor: pointer; font-weight: bold; }
        .score-area { text-align: center; margin-top: 20px; animation: pulse 2s infinite alternate; }
        .score-val { font-size: 3.5rem; font-weight: 900; text-shadow: 0 0 25px var(--primary); line-height: 1; }
        .score-sub { font-size: 0.9rem; color: #aaa; margin-top: 5px; }
        .feat-bar { display: flex; justify-content: center; gap: 20px; margin: 20px 0; }
        .feat-btn { background: rgba(255,255,255,0.05); width: 60px; height: 60px; border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; border: 1px solid rgba(255,255,255,0.1); cursor: pointer; transition: 0.2s; }
        .feat-btn:active { transform: scale(0.9); background: var(--primary); border-color: var(--primary); }
        .game-stage { flex-grow: 1; display: flex; justify-content: center; align-items: center; }
        .coin { width: 260px; height: 260px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, #0098EA, #005580); border: 8px solid rgba(255,255,255,0.1); box-shadow: 0 0 60px rgba(0, 152, 234, 0.5); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.08s; position: relative; }
        .coin:active { transform: scale(0.92); }
        .coin-svg { width: 60%; fill: #fff; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.3)); }
        .energy-wrap { margin: 0 20px; background: var(--panel); padding: 12px; border-radius: 15px; border: 1px solid #333; }
        .progress-bg { background: #000; height: 10px; border-radius: 5px; overflow: hidden; margin-top: 8px; }
        .progress-fill { height: 100%; width: 100%; background: linear-gradient(90deg, #fff, var(--primary)); transition: width 0.3s; }
        .nav { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(15px); border-top: 1px solid #333; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 10px 15px; padding-bottom: calc(15px + env(safe-area-inset-bottom)); z-index: 800; }
        .nav-item { background: rgba(255,255,255,0.03); color: #fff; border: none; padding: 12px; border-radius: 12px; font-weight: bold; font-size: 0.9rem; display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .nav-item:active { background: rgba(255,255,255,0.1); }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; display: flex; align-items: flex-end; justify-content: center; opacity: 0; visibility: hidden; transition: 0.3s; }
        .modal.active { opacity: 1; visibility: visible; }
        .modal-card { background: #151515; width: 100%; max-width: 500px; border-radius: 30px 30px 0 0; padding: 30px 20px; border-top: 3px solid var(--primary); transform: translateY(100%); transition: 0.4s cubic-bezier(0.19, 1, 0.22, 1); max-height: 85vh; overflow-y: auto; text-align: center; padding-bottom: 50px; }
        .modal.active .modal-card { transform: translateY(0); }
        .btn { width: 100%; padding: 16px; background: var(--primary); color: #fff; border: none; border-radius: 14px; font-weight: bold; margin-top: 15px; font-size: 1rem; cursor: pointer; box-shadow: 0 5px 15px rgba(0, 152, 234, 0.3); }
        .btn-close { background: #333; box-shadow: none; margin-top: 10px; }
        .inp { width: 100%; padding: 15px; background: #000; border: 1px solid #444; color: #fff; border-radius: 12px; margin-bottom: 12px; text-align: center; font-size: 1rem; }
        .quiz-option { background: #252525; padding: 15px; border-radius: 12px; margin-bottom: 10px; cursor: pointer; border: 1px solid #333; font-size: 1.1rem; transition: 0.2s; }
        .quiz-option:active { transform: scale(0.98); }
        .correct { background: var(--success) !important; color: #000; border-color: var(--success); }
        .wrong { background: var(--danger) !important; border-color: var(--danger); }
        .day-box { width: 40px; height: 40px; background: #333; border-radius: 8px; display: flex; align-items: center; justify-content: center; opacity: 0.5; font-size: 0.8rem; }
        .day-box.active { opacity: 1; background: var(--success); color: #000; font-weight: bold; }
    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div><h2 style="color:#fff">TON LEGEND</h2><p style="color:#666">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...</p></div>
    <div class="header"><div class="user-info"><span class="rank-badge" id="rank-badge">Bronze ü•â</span><span style="font-size:0.8rem; opacity:0.7" id="user-id">ID: ...</span></div><button class="lang-btn" onclick="toggleLang()" id="lang-btn">üá∫üá∏ EN</button></div>
    <div class="score-area"><div class="score-val" id="score">0</div><div class="score-sub" data-key="points_lbl">TON Points</div></div>
    <div class="feat-bar"><div class="feat-btn" onclick="openDaily()">üìÖ</div><div class="feat-btn" onclick="openModal('codes')">üéÅ</div><div class="feat-btn" onclick="openModal('shop')">üíé</div></div>
    <div class="game-stage"><div class="coin" onclick="tap(event)"><svg class="coin-svg" viewBox="0 0 24 24"><path d="M12 22L1.5 8 12 2l10.5 6L12 22zm0-2.5l8-10-8-5.5-8 5.5 8 10z"/></svg></div></div>
    <div class="energy-wrap"><div style="display:flex; justify-content:space-between; font-size:0.9rem"><span data-key="energy_lbl">Energy</span><span id="energy-txt">100/100</span></div><div class="progress-bg"><div class="progress-fill" id="energy-bar"></div></div></div>
    <div class="nav"><div class="nav-item" onclick="openModal('shop')"><span>üõí</span> <span data-key="shop_btn">Shop</span></div><div class="nav-item" onclick="openModal('tasks')"><span>üìã</span> <span data-key="tasks_btn">Tasks</span></div><div class="nav-item" onclick="startQuiz()"><span>‚ùì</span> <span data-key="quiz_btn">Quiz</span></div></div>
    <div class="modal" id="daily"><div class="modal-card"><h2 data-key="daily_title">Daily Reward</h2><div class="streak-container" id="streak-dots"><div class="day-box">1</div><div class="day-box">2</div><div class="day-box">3</div><div class="day-box">4</div><div class="day-box">5</div><div class="day-box">6</div><div class="day-box">7</div></div><p id="daily-status" style="color:#aaa; margin-bottom:20px">...</p><button class="btn" id="claim-btn" onclick="claimDaily()">Claim</button><button class="btn btn-close" onclick="closeModal('daily')" data-key="close_btn">Close</button></div></div>
    <div class="modal" id="quiz"><div class="modal-card"><h2 data-key="quiz_title">Challenge</h2><div style="width:100%; background:#333; height:5px; border-radius:5px; margin:10px 0; overflow:hidden"><div id="quiz-progress" style="width:0%; height:100%; background:var(--primary); transition:0.3s"></div></div><div style="font-size:3rem; margin:10px 0;" id="q-flag"></div><h3 id="q-text" style="margin-bottom:20px">Question?</h3><div id="q-opts"></div><button class="btn btn-close" onclick="closeModal('quiz')" data-key="exit_btn">Exit</button></div></div>
    <div class="modal" id="tasks"><div class="modal-card"><h2 data-key="tasks_title">Tasks</h2><div id="task-list"></div><button class="btn btn-close" onclick="closeModal('tasks')" data-key="close_btn">Close</button></div></div>
    <div class="modal" id="shop"><div class="modal-card"><h2 data-key="shop_title">Shop</h2><input class="inp" id="shop-link" placeholder="@username"><input class="inp" type="number" id="shop-count" placeholder="Count (Min 100)"><button class="btn" onclick="buy()" data-key="buy_btn">Buy Followers</button><button class="btn btn-close" onclick="closeModal('shop')" data-key="close_btn">Close</button></div></div>
    <div class="modal" id="codes"><div class="modal-card"><h2 data-key="code_title">Promo Code</h2><input class="inp" id="code-inp" placeholder="Enter Code"><button class="btn" onclick="redeem()" data-key="check_btn">Check</button><button class="btn btn-close" onclick="closeModal('codes')" data-key="close_btn">Close</button></div></div>

    <script>
        // ================= CONFIGURATION =================
        const CONFIG = {
            botToken: "8207071306:AAFqIFqsANxB7srrBEsUfZJkb4xzhsY5FMQ", // ŸÑÿß ÿ™ÿ¥ÿßÿ±ŸÉ Ÿáÿ∞ÿß ÿßŸÑÿ±ŸÖÿ≤
            adminId: "1759629479",
            energyRegenRate: 2000, // ms
            baseApiUrl: "https://your-backend-url.com/api" // <-- ÿ∫ŸäŸëÿ± Ÿáÿ∞ÿß ÿ•ŸÑŸâ ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿÆÿßÿØŸÖ ÿßŸÑÿÆÿßÿµ ÿ®ŸÉ
        };

        // ================= STATIC DATA =================
        const QUIZ_DATA = [
            { id: 1, flag: "üáÆüá∂", q_ar: "ŸÖÿß Ÿáÿ∞Ÿá ÿßŸÑÿØŸàŸÑÿ©ÿü", q_en: "Which country?", ans_ar: ["ÿßŸÑÿπÿ±ÿßŸÇ", "ŸÖÿµÿ±", "ÿ≥Ÿàÿ±Ÿäÿß"], ans_en: ["Iraq", "Egypt", "Syria"], c: 0, reward: 100, penalty: 50 },
            { id: 2, flag: "üá∏üá¶", q_ar: "ŸÖÿß Ÿáÿ∞Ÿá ÿßŸÑÿØŸàŸÑÿ©ÿü", q_en: "Which country?", ans_ar: ["ÿßŸÑŸÉŸàŸäÿ™", "ÿßŸÑÿ≥ÿπŸàÿØŸäÿ©", "ŸÇÿ∑ÿ±"], ans_en: ["Kuwait", "KSA", "Qatar"], c: 1, reward: 100, penalty: 50 },
            { id: 3, flag: "üá∫üá∏", q_ar: "ŸÖÿß Ÿáÿ∞Ÿá ÿßŸÑÿØŸàŸÑÿ©ÿü", q_en: "Which country?", ans_ar: ["ŸÉŸÜÿØÿß", "ÿ£ŸÖÿ±ŸäŸÉÿß", "ÿßŸÑŸÖŸÉÿ≥ŸäŸÉ"], ans_en: ["Canada", "USA", "Mexico"], c: 1, reward: 100, penalty: 50 },
        ];
        const TASKS = [
            { id: 1, t_ar: "ÿßÿ¥ÿ™ÿ±ŸÉ ŸÅŸä ŸÇŸÜÿßÿ™ŸÜÿß", t_en: "Join Channel", u: "https://t.me/telegram", r: 200 },
            { id: 2, t_ar: "ÿ™ÿßÿ®ÿπŸÜÿß ÿßŸÜÿ≥ÿ™ŸÇÿ±ÿßŸÖ", t_en: "Follow Instagram", u: "https://instagram.com", r: 150 },
            { id: 3, t_ar: "ÿØÿπŸàÿ© ÿµÿØŸäŸÇ", t_en: "Invite Friend", u: "https://t.me/share/url?url=https://t.me/YOUR_BOT", r: 500 }
        ];
        const LANG = {
            ar: { points_lbl: "ŸÜŸÇÿßÿ∑ ÿ™ŸàŸÜ", energy_lbl: "ÿßŸÑÿ∑ÿßŸÇÿ©", shop_btn: "ÿßŸÑŸÖÿ™ÿ¨ÿ±", tasks_btn: "ÿßŸÑŸÖŸáÿßŸÖ", quiz_btn: "ŸÖÿ≥ÿßÿ®ŸÇÿ©", shop_title: "ÿ¥ÿ±ÿßÿ° ŸÖÿ™ÿßÿ®ÿπŸäŸÜ", tasks_title: "ÿßŸÑŸÖŸáÿßŸÖ", daily_title: "ÿßŸÑŸÖŸÉÿßŸÅÿ£ÿ© ÿßŸÑŸäŸàŸÖŸäÿ©", quiz_title: "ŸÖÿ≥ÿßÿ®ŸÇÿ© ÿßŸÑÿ£ÿπŸÑÿßŸÖ", code_title: "ŸÉŸàÿØ ŸáÿØŸäÿ©", buy_btn: "ÿ¥ÿ±ÿßÿ°", close_btn: "ÿ•ÿ∫ŸÑÿßŸÇ", exit_btn: "ÿÆÿ±Ÿàÿ¨", check_btn: "ÿ™ÿ≠ŸÇŸÇ", alert_succ: "ŸÜÿßÿ¨ÿ≠!", alert_fail: "ŸÅÿ¥ŸÑ!" },
            en: { points_lbl: "TON Points", energy_lbl: "Energy", shop_btn: "Shop", tasks_btn: "Tasks", quiz_btn: "Quiz", shop_title: "Buy Followers", tasks_title: "Tasks", daily_title: "Daily Reward", quiz_title: "Flag Quiz", code_title: "Promo Code", buy_btn: "Buy", close_btn: "Close", exit_btn: "Exit", check_btn: "Check", alert_succ: "Success!", alert_fail: "Fail!" }
        };

        // ================= NEW: SERVER API SIMULATOR =================
        // Ÿáÿ∞ÿß ÿßŸÑÿ¨ÿ≤ÿ° Ÿäÿ≠ÿßŸÉŸä Ÿàÿ¨ŸàÿØ ÿÆÿßÿØŸÖ ÿ≠ŸÇŸäŸÇŸä.
        // ŸÅŸä ÿßŸÑŸÖÿ≥ÿ™ŸÇÿ®ŸÑÿå ÿ≥ÿ™ŸÇŸàŸÖ ÿ®ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ Ÿáÿ∞ÿß ÿßŸÑÿ¨ÿ≤ÿ° ÿ®ÿ∑ŸÑÿ®ÿßÿ™ `fetch` ÿ≠ŸÇŸäŸÇŸäÿ©.
        const ServerAPI = {
            // ÿ®ŸäÿßŸÜÿßÿ™ ŸàŸáŸÖŸäÿ© ŸÖÿÆÿ≤ŸÜÿ© ŸÖÿ≠ŸÑŸäÿßŸã ŸÑŸÑŸÖÿ≠ÿßŸÉÿßÿ©
            _mockDB: {
                score: parseInt(localStorage.getItem('score_v17' ) || 0),
                energy: 100,
                doneTasks: JSON.parse(localStorage.getItem('done_tasks_v17') || "[]"),
                lastDailyDate: localStorage.getItem('last_daily_date_v17'),
                streak: parseInt(localStorage.getItem('streak_v17') || 1)
            },

            // ÿØÿßŸÑÿ© ŸÑÿ¨ŸÑÿ® ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ£ŸàŸÑŸäÿ©
            getUserData: async (userId) => {
                console.log(`[API] Fetching data for user ${userId}`);
                // SIMULATION: Just return the mock data
                return new Promise(resolve => setTimeout(() => resolve({
                    success: true,
                    data: ServerAPI._mockDB
                }), 500));
                /*
                // REAL IMPLEMENTATION:
                const response = await fetch(`${CONFIG.baseApiUrl}/user/${userId}`);
                return await response.json();
                */
            },

            // ÿØÿßŸÑÿ© ŸÑÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑŸÜŸÇÿ±ÿßÿ™
            syncTap: async (userId) => {
                console.log(`[API] Syncing tap for user ${userId}`);
                // SIMULATION:
                if (ServerAPI._mockDB.energy > 0) {
                    ServerAPI._mockDB.score++;
                    ServerAPI._mockDB.energy--;
                    localStorage.setItem('score_v17', ServerAPI._mockDB.score); // Save for persistence in demo
                    return { success: true, data: { score: ServerAPI._mockDB.score, energy: ServerAPI._mockDB.energy } };
                }
                return { success: false, message: "No energy" };
                /*
                // REAL IMPLEMENTATION:
                const response = await fetch(`${CONFIG.baseApiUrl}/user/tap`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId })
                });
                return await response.json();
                */
            },

            // ÿØÿßŸÑÿ© ŸÑÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±
            submitQuizAnswer: async (userId, questionId, isCorrect) => {
                console.log(`[API] Submitting quiz answer for user ${userId}`);
                // SIMULATION:
                const question = QUIZ_DATA.find(q => q.id === questionId);
                if (isCorrect) {
                    ServerAPI._mockDB.score += question.reward;
                } else {
                    ServerAPI._mockDB.score = Math.max(0, ServerAPI._mockDB.score - question.penalty);
                }
                localStorage.setItem('score_v17', ServerAPI._mockDB.score);
                return { success: true, data: { score: ServerAPI._mockDB.score } };
            },
            
            // ÿØÿßŸÑÿ© ŸÑŸÑŸÖÿ∑ÿßŸÑÿ®ÿ© ÿ®ÿßŸÑŸÖŸÉÿßŸÅÿ£ÿ© ÿßŸÑŸäŸàŸÖŸäÿ©
            claimDailyReward: async (userId) => {
                console.log(`[API] Claiming daily reward for user ${userId}`);
                // SIMULATION:
                const today = new Date().toDateString();
                if (ServerAPI._mockDB.lastDailyDate === today) {
                    return { success: false, message: "Already claimed today" };
                }
                ServerAPI._mockDB.score += (ServerAPI._mockDB.streak * 100);
                ServerAPI._mockDB.lastDailyDate = today;
                if (ServerAPI._mockDB.streak < 7) ServerAPI._mockDB.streak++; else ServerAPI._mockDB.streak = 1;
                
                localStorage.setItem('score_v17', ServerAPI._mockDB.score);
                localStorage.setItem('last_daily_date_v17', ServerAPI._mockDB.lastDailyDate);
                localStorage.setItem('streak_v17', ServerAPI._mockDB.streak);

                return { success: true, data: { score: ServerAPI._mockDB.score, streak: ServerAPI._mockDB.streak } };
            },
            
            // ÿØÿßŸÑÿ© ŸÑÿ•ŸÉŸÖÿßŸÑ ŸÖŸáŸÖÿ©
            completeTask: async (userId, taskId, reward) => {
                console.log(`[API] Completing task ${taskId} for user ${userId}`);
                // SIMULATION:
                if (!ServerAPI._mockDB.doneTasks.includes(taskId)) {
                    ServerAPI._mockDB.score += reward;
                    ServerAPI._mockDB.doneTasks.push(taskId);
                    localStorage.setItem('score_v17', ServerAPI._mockDB.score);
                    localStorage.setItem('done_tasks_v17', JSON.stringify(ServerAPI._mockDB.doneTasks));
                    return { success: true, data: { score: ServerAPI._mockDB.score, doneTasks: ServerAPI._mockDB.doneTasks } };
                }
                return { success: false, message: "Task already completed" };
            }
        };

        // ================= ENGINE =================
        const tg = window.Telegram.WebApp; tg.expand();
        
        let state = {
            userId: tg.initDataUnsafe?.user?.id || "Guest",
            score: 0,
            energy: 0,
            maxEnergy: 100,
            lang: localStorage.getItem('lang') || 'ar',
            doneTasks: [],
            quizIndex: 0
        };

        // --- INITIALIZATION ---
        window.onload = async () => {
            document.getElementById('user-id').innerText = "ID: " + state.userId;
            applyLang(state.lang);

            // Fetch initial user data from server
            const response = await ServerAPI.getUserData(state.userId);
            if (response.success) {
                state = { ...state, ...response.data };
                console.log("Initial state loaded:", state);
            } else {
                tg.showAlert("Failed to load user data.");
            }

            // Hide loader and update UI
            setTimeout(() => {
                document.getElementById('loader').style.opacity = '0';
                setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
                updateUI();
            }, 500);
        };

        // --- CORE LOGIC ---
        
        // Energy Regen (Client-side prediction, server is the source of truth)
        setInterval(() => {
            if(state.energy < state.maxEnergy) {
                state.energy++;
                updateUI();
            }
        }, CONFIG.energyRegenRate);

        // Click Handler
        async function tap(e) {
            if(state.energy > 0) {
                // Optimistic UI update
                state.score++; state.energy--;
                updateUI();
                floatNum(e.clientX, e.clientY);
                if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');

                // Sync with server
                const response = await ServerAPI.syncTap(state.userId);
                if (response.success) {
                    // Re-sync state with server response
                    state.score = response.data.score;
                    state.energy = response.data.energy;
                } else {
                    // Rollback if server fails (e.g., out of energy)
                    // This part needs more robust implementation in a real app
                    console.error("Sync failed:", response.message);
                }
                updateUI();
            }
        }

        // --- FEATURES ---

        // 1. Quiz Logic
        function startQuiz() {
            state.quizIndex = 0;
            openModal('quiz');
            renderQuestion();
        }

        function renderQuestion() {
            if(state.quizIndex >= QUIZ_DATA.length) {
                tg.showAlert("Quiz Completed! üéâ");
                closeModal('quiz');
                return;
            }
            const q = QUIZ_DATA[state.quizIndex];
            const isAr = state.lang === 'ar';
            document.getElementById('quiz-progress').style.width = ((state.quizIndex / QUIZ_DATA.length) * 100) + "%";
            document.getElementById('q-flag').innerText = q.flag;
            document.getElementById('q-text').innerText = isAr ? q.q_ar : q.q_en;
            const opts = document.getElementById('q-opts');
            opts.innerHTML = '';
            const answers = isAr ? q.ans_ar : q.ans_en;
            answers.forEach((ans, i) => {
                const btn = document.createElement('div');
                btn.className = 'quiz-option';
                btn.innerText = ans;
                btn.onclick = () => answerQuiz(btn, i === q.c, q.id);
                opts.appendChild(btn);
            });
        }

        async function answerQuiz(btn, isCorrect, questionId) {
            if(btn.classList.contains('correct') || btn.classList.contains('wrong')) return;

            btn.classList.add(isCorrect ? 'correct' : 'wrong');
            
            // Send answer to server
            const response = await ServerAPI.submitQuizAnswer(state.userId, questionId, isCorrect);
            if (response.success) {
                state.score = response.data.score;
                tg.showAlert(isCorrect ? `+${QUIZ_DATA.find(q=>q.id===questionId).reward}` : `-${QUIZ_DATA.find(q=>q.id===questionId).penalty}`);
            }
            updateUI();

            setTimeout(() => {
                state.quizIndex++;
                renderQuestion();
            }, 1000);
        }

        // 2. Daily Reward
        function openDaily() {
            openModal('daily');
            // This data should ideally come from the server on modal open
            const today = new Date().toDateString();
            const last = state.lastDailyDate;
            let streak = state.streak;
            
            const dots = document.querySelectorAll('.day-box');
            dots.forEach((d, i) => {
                if(i < streak -1) d.classList.add('active'); else d.classList.remove('active');
            });
            if (last === today) {
                 dots[streak-1]?.classList.add('active');
            }


            const btn = document.getElementById('claim-btn');
            const status = document.getElementById('daily-status');
            const isAr = state.lang === 'ar';

            if(last === today) {
                btn.disabled = true;
                btn.style.background = "#333";
                btn.innerText = isAr ? "ÿπÿØ ÿ∫ÿØÿßŸã" : "Come Tomorrow";
                status.innerText = isAr ? "ÿ™ŸÖ ÿßŸÑÿßÿ≥ÿ™ŸÑÿßŸÖ ‚úÖ" : "Claimed ‚úÖ";
            } else {
                btn.disabled = false;
                btn.style.background = "var(--primary)";
                btn.innerText = isAr ? "ÿßÿ≥ÿ™ŸÑÿßŸÖ" : "Claim";
                status.innerText = isAr ? `ÿßŸÑŸäŸàŸÖ ${streak}` : `Day ${streak}`;
            }
        }

        async function claimDaily() {
            const response = await ServerAPI.claimDailyReward(state.userId);
            if (response.success) {
                state.score = response.data.score;
                state.streak = response.data.streak;
                state.lastDailyDate = new Date().toDateString(); // Update local state
                updateUI();
                openDaily(); // Refresh modal view
            } else {
                tg.showAlert(response.message);
            }
        }

        // 3. Tasks & Shop
        function openTasks() {
            openModal('tasks');
            const list = document.getElementById('task-list');
            list.innerHTML = '';
            TASKS.forEach(t => {
                const isDone = state.doneTasks.includes(t.id);
                const title = state.lang==='ar' ? t.t_ar : t.t_en;
                list.innerHTML += `
                <div style="background:#222; padding:12px; border-radius:10px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; opacity:${isDone ? 0.5 : 1}">
                    <div><b>${title}</b><div style="color:var(--success);font-size:0.8rem">+${t.r}</div></div>
                    <button ${isDone ? 'disabled' : ''} onclick="doTask(${t.id}, '${t.u}', ${t.r})" style="background:${isDone ? '#333' : 'var(--primary)'}; border:none; color:#fff; padding:5px 15px; border-radius:8px">${isDone ? 'Done' : 'GO'}</button>
                </div>`;
            });
        }

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TON Legend V16</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #050505;
            --panel: #1a1a1a;
            --primary: #0098EA; /* Ù„ÙˆÙ† ØªÙˆÙ† */
            --gold: #FFD700;
            --success: #2ecc71;
            --danger: #e74c3c;
            --text: #ffffff;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0; height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden;
            background-image: radial-gradient(circle at 50% 10%, #1a2a3a, #000);
            padding-bottom: 90px; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ© */
        }

        /* --- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ --- */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999; display: flex; flex-direction: column;
            justify-content: center; align-items: center; transition: opacity 0.5s;
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid #333;
            border-top: 5px solid var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- Ø§Ù„Ø±Ø£Ø³ (Header) --- */
        .header {
            padding: 15px; display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.03); border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .user-info { display: flex; gap: 10px; align-items: center; }
        .rank-badge { background: var(--gold); color: #000; padding: 3px 10px; border-radius: 10px; font-weight: bold; font-size: 0.8rem; }
        .lang-btn { background: transparent; border: 1px solid var(--primary); color: var(--primary); padding: 5px 12px; border-radius: 15px; cursor: pointer; font-weight: bold; }

        /* --- Ø§Ù„Ø¹Ø¯Ø§Ø¯ (Score) --- */
        .score-area { text-align: center; margin-top: 20px; animation: pulse 2s infinite alternate; }
        .score-val { font-size: 3.5rem; font-weight: 900; text-shadow: 0 0 25px var(--primary); line-height: 1; }
        .score-sub { font-size: 0.9rem; color: #aaa; margin-top: 5px; }

        /* --- Ø´Ø±ÙŠØ· Ø§Ù„Ù…ÙŠØ²Ø§Øª (Features) --- */
        .feat-bar { display: flex; justify-content: center; gap: 20px; margin: 20px 0; }
        .feat-btn {
            background: rgba(255,255,255,0.05); width: 60px; height: 60px; border-radius: 18px;
            display: flex; align-items: center; justify-content: center; font-size: 1.8rem;
            border: 1px solid rgba(255,255,255,0.1); cursor: pointer; transition: 0.2s;
        }
        .feat-btn:active { transform: scale(0.9); background: var(--primary); border-color: var(--primary); }

        /* --- Ø§Ù„Ø¹Ù…Ù„Ø© (The Coin) --- */
        .game-stage { flex-grow: 1; display: flex; justify-content: center; align-items: center; }
        .coin {
            width: 260px; height: 260px; border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #0098EA, #005580);
            border: 8px solid rgba(255,255,255,0.1);
            box-shadow: 0 0 60px rgba(0, 152, 234, 0.5);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.08s; position: relative;
        }
        .coin:active { transform: scale(0.92); }
        .coin-svg { width: 60%; fill: #fff; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.3)); }

        /* --- Ø§Ù„Ø·Ø§Ù‚Ø© --- */
        .energy-wrap { margin: 0 20px; background: var(--panel); padding: 12px; border-radius: 15px; border: 1px solid #333; }
        .progress-bg { background: #000; height: 10px; border-radius: 5px; overflow: hidden; margin-top: 8px; }
        .progress-fill { height: 100%; width: 100%; background: linear-gradient(90deg, #fff, var(--primary)); transition: width 0.3s; }

        /* --- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ© (Fixed Nav) --- */
        .nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(15px);
            border-top: 1px solid #333;
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
            padding: 10px 15px; padding-bottom: calc(15px + env(safe-area-inset-bottom));
            z-index: 800;
        }
        .nav-item {
            background: rgba(255,255,255,0.03); color: #fff; border: none;
            padding: 12px; border-radius: 12px; font-weight: bold; font-size: 0.9rem;
            display: flex; flex-direction: column; align-items: center; cursor: pointer;
        }
        .nav-item:active { background: rgba(255,255,255,0.1); }

        /* --- Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (Modals) --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 1000;
            display: flex; align-items: flex-end; justify-content: center;
            opacity: 0; visibility: hidden; transition: 0.3s;
        }
        .modal.active { opacity: 1; visibility: visible; }
        .modal-card {
            background: #151515; width: 100%; max-width: 500px;
            border-radius: 30px 30px 0 0; padding: 30px 20px;
            border-top: 3px solid var(--primary);
            transform: translateY(100%); transition: 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            max-height: 85vh; overflow-y: auto; text-align: center;
            padding-bottom: 50px;
        }
        .modal.active .modal-card { transform: translateY(0); }

        /* --- Ø¹Ù†Ø§ØµØ± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… --- */
        .btn { width: 100%; padding: 16px; background: var(--primary); color: #fff; border: none; border-radius: 14px; font-weight: bold; margin-top: 15px; font-size: 1rem; cursor: pointer; box-shadow: 0 5px 15px rgba(0, 152, 234, 0.3); }
        .btn-close { background: #333; box-shadow: none; margin-top: 10px; }
        .inp { width: 100%; padding: 15px; background: #000; border: 1px solid #444; color: #fff; border-radius: 12px; margin-bottom: 12px; text-align: center; font-size: 1rem; }

        /* Quiz Specific */
        .quiz-option {
            background: #252525; padding: 15px; border-radius: 12px; margin-bottom: 10px;
            cursor: pointer; border: 1px solid #333; font-size: 1.1rem; transition: 0.2s;
        }
        .quiz-option:active { transform: scale(0.98); }
        .correct { background: var(--success) !important; color: #000; border-color: var(--success); }
        .wrong { background: var(--danger) !important; border-color: var(--danger); }

        /* Daily Reward */
        .streak-container { display: flex; gap: 5px; justify-content: center; margin: 20px 0; }
        .day-box { width: 40px; height: 40px; background: #333; border-radius: 8px; display: flex; align-items: center; justify-content: center; opacity: 0.5; font-size: 0.8rem; }
        .day-box.active { opacity: 1; background: var(--success); color: #000; font-weight: bold; }

    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <h2 style="color:#fff">TON LEGEND</h2>
        <p style="color:#666">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
    </div>

    <div class="header">
        <div class="user-info">
            <span class="rank-badge" id="rank-badge">Bronze ğŸ¥‰</span>
            <span style="font-size:0.8rem; opacity:0.7" id="user-id">ID: ...</span>
        </div>
        <button class="lang-btn" onclick="toggleLang()" id="lang-btn">ğŸ‡ºğŸ‡¸ EN</button>
    </div>

    <div class="score-area">
        <div class="score-val" id="score">0</div>
        <div class="score-sub" data-key="points_lbl">TON Points</div>
    </div>

    <div class="feat-bar">
        <div class="feat-btn" onclick="openDaily()">ğŸ“…</div>
        <div class="feat-btn" onclick="openModal('codes')">ğŸ</div>
        <div class="feat-btn" onclick="openModal('shop')">ğŸ’</div>
    </div>

    <div class="game-stage">
        <div class="coin" onclick="tap(event)">
            <svg class="coin-svg" viewBox="0 0 24 24"><path d="M12 22L1.5 8 12 2l10.5 6L12 22zm0-2.5l8-10-8-5.5-8 5.5 8 10z"/></svg>
        </div>
    </div>

    <div class="energy-wrap">
        <div style="display:flex; justify-content:space-between; font-size:0.9rem">
            <span data-key="energy_lbl">Energy</span>
            <span id="energy-txt">100/100</span>
        </div>
        <div class="progress-bg"><div class="progress-fill" id="energy-bar"></div></div>
    </div>

    <div class="nav">
        <div class="nav-item" onclick="openModal('shop')">
            <span>ğŸ›’</span> <span data-key="shop_btn">Shop</span>
        </div>
        <div class="nav-item" onclick="openModal('tasks')">
            <span>ğŸ“‹</span> <span data-key="tasks_btn">Tasks</span>
        </div>
        <div class="nav-item" onclick="startQuiz()">
            <span>â“</span> <span data-key="quiz_btn">Quiz</span>
        </div>
    </div>

    <div class="modal" id="daily">
        <div class="modal-card">
            <h2 data-key="daily_title">Daily Reward</h2>
            <div class="streak-container" id="streak-dots">
                <div class="day-box">1</div><div class="day-box">2</div><div class="day-box">3</div>
                <div class="day-box">4</div><div class="day-box">5</div><div class="day-box">6</div><div class="day-box">7</div>
            </div>
            <p id="daily-status" style="color:#aaa; margin-bottom:20px">...</p>
            <button class="btn" id="claim-btn" onclick="claimDaily()">Claim</button>
            <button class="btn btn-close" onclick="closeModal('daily')" data-key="close_btn">Close</button>
        </div>
    </div>

    <div class="modal" id="quiz">
        <div class="modal-card">
            <h2 data-key="quiz_title">Challenge</h2>
            <div style="width:100%; background:#333; height:5px; border-radius:5px; margin:10px 0; overflow:hidden">
                <div id="quiz-progress" style="width:0%; height:100%; background:var(--primary); transition:0.3s"></div>
            </div>
            <div style="font-size:3rem; margin:10px 0;" id="q-flag"></div>
            <h3 id="q-text" style="margin-bottom:20px">Question?</h3>
            <div id="q-opts"></div>
            <button class="btn btn-close" onclick="closeModal('quiz')" data-key="exit_btn">Exit</button>
        </div>
    </div>

    <div class="modal" id="tasks">
        <div class="modal-card">
            <h2 data-key="tasks_title">Tasks</h2>
            <div id="task-list"></div>
            <button class="btn btn-close" onclick="closeModal('tasks')" data-key="close_btn">Close</button>
        </div>
    </div>

    <div class="modal" id="shop">
        <div class="modal-card">
            <h2 data-key="shop_title">Shop</h2>
            <input class="inp" id="shop-link" placeholder="@username">
            <input class="inp" type="number" id="shop-count" placeholder="Count (Min 100)">
            <button class="btn" onclick="buy()" data-key="buy_btn">Buy Followers</button>
            <button class="btn btn-close" onclick="closeModal('shop')" data-key="close_btn">Close</button>
        </div>
    </div>

    <div class="modal" id="codes">
        <div class="modal-card">
            <h2 data-key="code_title">Promo Code</h2>
            <input class="inp" id="code-inp" placeholder="Enter Code">
            <button class="btn" onclick="redeem()" data-key="check_btn">Check</button>
            <button class="btn btn-close" onclick="closeModal('codes')" data-key="close_btn">Close</button>
        </div>
    </div>

    <script>
        // ================= CONFIGURATION =================
        const CONFIG = {
            botToken: "8207071306:AAFqIFqsANxB7srrBEsUfZJkb4xzhsY5FMQ",
            adminId: "1759629479"
        };

        // ================= DATA =================
        const QUIZ_DATA = [
            { flag: "ğŸ‡®ğŸ‡¶", q_ar: "Ù…Ø§ Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆÙ„Ø©ØŸ", q_en: "Which country?", ans_ar: ["Ø§Ù„Ø¹Ø±Ø§Ù‚", "Ù…ØµØ±", "Ø³ÙˆØ±ÙŠØ§"], ans_en: ["Iraq", "Egypt", "Syria"], c: 0 },
            { flag: "ğŸ‡¸ğŸ‡¦", q_ar: "Ù…Ø§ Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆÙ„Ø©ØŸ", q_en: "Which country?", ans_ar: ["Ø§Ù„ÙƒÙˆÙŠØª", "Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©", "Ù‚Ø·Ø±"], ans_en: ["Kuwait", "KSA", "Qatar"], c: 1 },
            { flag: "ğŸ‡ºğŸ‡¸", q_ar: "Ù…Ø§ Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆÙ„Ø©ØŸ", q_en: "Which country?", ans_ar: ["ÙƒÙ†Ø¯Ø§", "Ø£Ù…Ø±ÙŠÙƒØ§", "Ø§Ù„Ù…ÙƒØ³ÙŠÙƒ"], ans_en: ["Canada", "USA", "Mexico"], c: 1 },
            { flag: "ğŸ‡¹ğŸ‡·", q_ar: "Ù…Ø§ Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆÙ„Ø©ØŸ", q_en: "Which country?", ans_ar: ["ØªÙˆÙ†Ø³", "Ù„ÙŠØ¨ÙŠØ§", "ØªØ±ÙƒÙŠØ§"], ans_en: ["Tunisia", "Libya", "Turkey"], c: 2 },
            { flag: "ğŸ‡§ğŸ‡·", q_ar: "Ù…Ø§ Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆÙ„Ø©ØŸ", q_en: "Which country?", ans_ar: ["Ø§Ù„Ø¨Ø±Ø§Ø²ÙŠÙ„", "Ø§Ù„Ø£Ø±Ø¬Ù†ØªÙŠÙ†", "ØªØ´ÙŠÙ„ÙŠ"], ans_en: ["Brazil", "Argentina", "Chile"], c: 0 }
        ];

        const TASKS = [
            { id: 1, t_ar: "Ø§Ø´ØªØ±Ùƒ ÙÙŠ Ù‚Ù†Ø§ØªÙ†Ø§", t_en: "Join Channel", u: "https://t.me/telegram", r: 200 },
            { id: 2, t_ar: "ØªØ§Ø¨Ø¹Ù†Ø§ Ø§Ù†Ø³ØªÙ‚Ø±Ø§Ù…", t_en: "Follow Instagram", u: "https://instagram.com", r: 150 },
            { id: 3, t_ar: "Ø¯Ø¹ÙˆØ© ØµØ¯ÙŠÙ‚", t_en: "Invite Friend", u: "https://t.me/share/url?url=https://t.me/YOUR_BOT", r: 500 }
        ];

        const LANG = {
            ar: { points_lbl: "Ù†Ù‚Ø§Ø· ØªÙˆÙ†", energy_lbl: "Ø§Ù„Ø·Ø§Ù‚Ø©", shop_btn: "Ø§Ù„Ù…ØªØ¬Ø±", tasks_btn: "Ø§Ù„Ù…Ù‡Ø§Ù…", quiz_btn: "Ù…Ø³Ø§Ø¨Ù‚Ø©", shop_title: "Ø´Ø±Ø§Ø¡ Ù…ØªØ§Ø¨Ø¹ÙŠÙ†", tasks_title: "Ø§Ù„Ù…Ù‡Ø§Ù…", daily_title: "Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©", quiz_title: "Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ø£Ø¹Ù„Ø§Ù…", code_title: "ÙƒÙˆØ¯ Ù‡Ø¯ÙŠØ©", buy_btn: "Ø´Ø±Ø§Ø¡", close_btn: "Ø¥ØºÙ„Ø§Ù‚", exit_btn: "Ø®Ø±ÙˆØ¬", check_btn: "ØªØ­Ù‚Ù‚", alert_succ: "Ù†Ø§Ø¬Ø­!", alert_fail: "ÙØ´Ù„!" },
            en: { points_lbl: "TON Points", energy_lbl: "Energy", shop_btn: "Shop", tasks_btn: "Tasks", quiz_btn: "Quiz", shop_title: "Buy Followers", tasks_title: "Tasks", daily_title: "Daily Reward", quiz_title: "Flag Quiz", code_title: "Promo Code", buy_btn: "Buy", close_btn: "Close", exit_btn: "Exit", check_btn: "Check", alert_succ: "Success!", alert_fail: "Fail!" }
        };

        // ================= ENGINE =================
        const tg = window.Telegram.WebApp; tg.expand();
        
        let state = {
            score: parseInt(localStorage.getItem('score_v16') || 0),
            energy: 100,
            lang: localStorage.getItem('lang') || 'ar',
            doneTasks: JSON.parse(localStorage.getItem('done_tasks') || "[]"),
            quizIndex: 0
        };

        // Loading Screen
        window.onload = () => {
            setTimeout(() => {
                document.getElementById('loader').style.opacity = '0';
                setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
            }, 1500);
            
            // Set User ID
            const uid = tg.initDataUnsafe?.user?.id || "Guest";
            document.getElementById('user-id').innerText = "ID: " + uid;
            
            updateUI();
            applyLang(state.lang);
        };

        // Energy Regen
        setInterval(() => { if(state.energy<100) { state.energy++; updateUI(); } }, 2000);

        // Click Handler
        function tap(e) {
            if(state.energy > 0) {
                state.score++; state.energy--;
                save(); updateUI();
                floatNum(e.clientX, e.clientY);
                if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
            }
        }

        // --- FEATURES ---

        // 1. Quiz Logic (Fixed & Continuous)
        function startQuiz() {
            state.quizIndex = 0;
            openModal('quiz');
            renderQuestion();
        }

        function renderQuestion() {
            if(state.quizIndex >= QUIZ_DATA.length) {
                tg.showAlert("Quiz Completed! ğŸ‰");
                closeModal('quiz');
                return;
            }
            
            const q = QUIZ_DATA[state.quizIndex];
            const isAr = state.lang === 'ar';
            
            document.getElementById('quiz-progress').style.width = ((state.quizIndex / QUIZ_DATA.length) * 100) + "%";
            document.getElementById('q-flag').innerText = q.flag;
            document.getElementById('q-text').innerText = isAr ? q.q_ar : q.q_en;
            
            const opts = document.getElementById('q-opts');
            opts.innerHTML = '';
            
            const answers = isAr ? q.ans_ar : q.ans_en;
            answers.forEach((ans, i) => {
                const btn = document.createElement('div');
                btn.className = 'quiz-option';
                btn.innerText = ans;
                btn.onclick = () => answerQuiz(btn, i, q.c);
                opts.appendChild(btn);
            });
        }

        function answerQuiz(btn, selected, correct) {
            if(btn.classList.contains('correct') || btn.classList.contains('wrong')) return; // prevent double click

            if(selected === correct) {
                btn.classList.add('correct');
                state.score += 100;
                tg.showAlert("+100");
            } else {
                btn.classList.add('wrong');
                if(state.score >= 50) state.score -= 50;
                tg.showAlert("-50");
            }
            save(); updateUI();

            setTimeout(() => {
                state.quizIndex++;
                renderQuestion();
            }, 1000);
        }

        // 2. Daily Reward (Fixed)
        function openDaily() {
            openModal('daily');
            const today = new Date().toDateString();
            const last = localStorage.getItem('last_daily_date');
            let streak = parseInt(localStorage.getItem('streak') || 1);
            
            // Render Dots
            const dots = document.querySelectorAll('.day-box');
            dots.forEach((d, i) => {
                if(i < streak) d.classList.add('active');
                else d.classList.remove('active');
            });

            const btn = document.getElementById('claim-btn');
            const status = document.getElementById('daily-status');
            const isAr = state.lang === 'ar';

            if(last === today) {
                btn.disabled = true;
                btn.style.background = "#333";
                btn.innerText = isAr ? "Ø¹Ø¯ ØºØ¯Ø§Ù‹" : "Come Tomorrow";
                status.innerText = isAr ? "ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… âœ…" : "Claimed âœ…";
            } else {
                btn.disabled = false;
                btn.style.background = "var(--primary)";
                btn.innerText = isAr ? "Ø§Ø³ØªÙ„Ø§Ù…" : "Claim";
                status.innerText = isAr ? `Ø§Ù„ÙŠÙˆÙ… ${streak}` : `Day ${streak}`;
            }
        }

        function claimDaily() {
            let streak = parseInt(localStorage.getItem('streak') || 1);
            state.score += (streak * 100);
            localStorage.setItem('last_daily_date', new Date().toDateString());
            if(streak < 7) streak++; else streak = 1;
            localStorage.setItem('streak', streak);
            save(); updateUI(); openDaily();
        }

        // 3. Tasks & Shop
        function openTasks() {
            openModal('tasks');
            const list = document.getElementById('task-list');
            list.innerHTML = '';
            TASKS.filter(t => !state.doneTasks.includes(t.id)).forEach(t => {
                const title = state.lang==='ar' ? t.t_ar : t.t_en;
                list.innerHTML += `
                <div style="background:#222; padding:12px; border-radius:10px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center">
                    <div><b>${title}</b><div style="color:var(--success);font-size:0.8rem">+${t.r}</div></div>
                    <button onclick="doTask(${t.id}, '${t.u}', ${t.r})" style="background:var(--primary); border:none; color:#fff; padding:5px 15px; border-radius:8px">GO</button>
                </div>`;
            });
        }
        // Bind Tasks Button
        document.querySelector('div[onclick="openModal(\'tasks\')"]').onclick = openTasks;

        function doTask(id, url, r) {
            window.open(url);
            tg.showConfirm(state.lang==='ar'?"Ù‡Ù„ Ø§Ø´ØªØ±ÙƒØªØŸ":"Did you join?", ok => {
                if(ok) { state.score+=r; state.doneTasks.push(id); localStorage.setItem('done_tasks', JSON.stringify(state.doneTasks)); save(); updateUI(); openTasks(); }
            });
        }

        function buy() {
            const l = document.getElementById('shop-link').value;
            const c = document.getElementById('shop-count').value;
            const price = c * 4;
            if(state.score < price) return tg.showAlert("No Points");
            state.score -= price; save(); updateUI();
            fetch(`https://api.telegram.org/bot${CONFIG.botToken}/sendMessage?chat_id=${CONFIG.adminId}&text=NewOrder%0ALink:${l}%0ACount:${c}`);
            tg.showAlert("Sent!"); closeModal('shop');
        }

        // --- UTILS ---
        function toggleLang() {
            state.lang = state.lang === 'ar' ? 'en' : 'ar';
            localStorage.setItem('lang', state.lang);
            applyLang(state.lang);
        }

        function applyLang(l) {
            document.body.dir = l==='ar'?'rtl':'ltr';
            document.getElementById('lang-btn').innerText = l==='ar'?'ğŸ‡ºğŸ‡¸ EN':'ğŸ‡®ğŸ‡¶ AR';
            document.querySelectorAll('[data-key]').forEach(el => {
                if(LANG[l][el.getAttribute('data-key')]) el.innerText = LANG[l][el.getAttribute('data-key')];
            });
        }

        function updateUI() {
            document.getElementById('score').innerText = state.score.toLocaleString();
            document.getElementById('energy-txt').innerText = state.energy + "/100";
            document.getElementById('energy-bar').style.width = state.energy + "%";
            
            // Update Rank
            let rank = "Bronze ğŸ¥‰";
            if(state.score > 5000) rank = "Silver ğŸ¥ˆ";
            if(state.score > 20000) rank = "Gold ğŸ¥‡";
            if(state.score > 100000) rank = "Diamond ğŸ’";
            document.getElementById('rank-badge').innerText = rank;
        }

        function save() { localStorage.setItem('score_v16', state.score); }
        function openModal(id) { document.getElementById(id).classList.add('active'); if(id==='tasks') openTasks(); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function redeem() { if(document.getElementById('code-inp').value === "TON"){state.score+=1000; save(); updateUI(); closeModal('codes'); tg.showAlert("+1000");} }
        
        function floatNum(x, y) {
            const el = document.createElement('div'); el.innerText = '+1';
            el.style.cssText = `position:fixed; left:${x}px; top:${y}px; color:#fff; font-weight:bold; pointer-events:none; z-index:999; text-shadow:0 0 5px var(--primary); animation:fly 0.8s forwards;`;
            document.body.appendChild(el); setTimeout(()=>el.remove(), 800);
        }
        document.head.insertAdjacentHTML("beforeend", `<style>@keyframes fly {to{transform:translateY(-100px);opacity:0}}</style>`);

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TON Legend Ultimate</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0a0a0a;
            --primary: #0098EA;
            --primary-glow: rgba(0, 152, 234, 0.6);
            --secondary: #f39c12;
            --surface: rgba(255, 255, 255, 0.08);
            --border: rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
            --text-muted: #888;
            --success: #00E096;
            --danger: #FF3B30;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 0%, #1a3a5a, #000);
            color: var(--text-main);
            margin: 0; height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden;
            padding-bottom: 95px;
        }

        /* --- Animations --- */
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-80px) scale(1.5); } }
        @keyframes pulseGlow { 0% { box-shadow: 0 0 20px var(--primary-glow); } 100% { box-shadow: 0 0 40px var(--primary-glow); } }

        /* --- Header --- */
        .header {
            padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.2); backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            z-index: 10;
        }
        .user-badge { display: flex; align-items: center; gap: 10px; }
        .avatar { width: 35px; height: 35px; background: linear-gradient(45deg, var(--primary), #00d2ff); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; }
        .rank-info { display: flex; flex-direction: column; line-height: 1.2; }
        .rank-name { font-weight: 800; font-size: 0.9rem; color: var(--secondary); }
        .rank-bar-bg { width: 80px; height: 4px; background: #333; border-radius: 2px; margin-top: 3px; overflow: hidden; }
        .rank-bar-fill { height: 100%; background: var(--secondary); width: 0%; transition: width 0.5s; }

        /* --- Score Display --- */
        .score-container { text-align: center; margin-top: 30px; position: relative; }
        .score-val { font-size: 3.8rem; font-weight: 900; background: -webkit-linear-gradient(#fff, #bbb); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 15px rgba(255,255,255,0.3)); }
        .score-label { font-size: 0.9rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-top: -5px; }

        /* --- The Coin Area (3D Effect) --- */
        .game-stage { flex-grow: 1; display: flex; justify-content: center; align-items: center; perspective: 1000px; position: relative; }
        
        .coin-wrapper {
            width: 280px; height: 280px;
            border-radius: 50%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.1s ease-out;
            cursor: pointer;
            box-shadow: 0 0 80px rgba(0, 152, 234, 0.2);
        }
        
        .coin-wrapper:active { transform: scale(0.95) !important; }

        .coin-inner {
            width: 100%; height: 100%; border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #4facfe, #00f2fe);
            border: 10px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; justify-content: center;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.5), 0 10px 20px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }
        
        /* Coin Glare */
        .coin-inner::after {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: linear-gradient(to bottom right, rgba(255,255,255,0.4) 0%, transparent 40%, transparent 100%);
            pointer-events: none; transform: rotate(45deg);
        }

        .coin-logo { width: 65%; fill: #fff; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.4)); z-index: 2; }

        /* --- Floating Numbers --- */
        .float-num {
            position: absolute; color: #fff; font-weight: 900; font-size: 2rem;
            pointer-events: none; z-index: 100; text-shadow: 0 0 10px var(--primary);
            animation: floatUp 0.8s forwards;
        }

        /* --- Controls & Stats --- */
        .controls-row { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; }
        .mini-btn {
            background: var(--surface); border: 1px solid var(--border);
            padding: 10px 20px; border-radius: 20px; color: #fff;
            display: flex; align-items: center; gap: 8px; font-weight: bold;
            font-size: 0.9rem; transition: 0.2s;
        }
        .mini-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.15); }

        /* --- Energy Bar --- */
        .energy-container {
            margin: 0 25px 20px 25px;
            background: rgba(0,0,0,0.3); padding: 10px 15px;
            border-radius: 20px; border: 1px solid var(--border);
            backdrop-filter: blur(5px);
        }
        .energy-info { display: flex; justify-content: space-between; font-size: 0.85rem; font-weight: bold; margin-bottom: 8px; }
        .energy-track { height: 12px; background: rgba(255,255,255,0.05); border-radius: 6px; overflow: hidden; position: relative; }
        .energy-fill { height: 100%; background: linear-gradient(90deg, #ffd700, #f39c12); width: 100%; transition: width 0.2s linear; box-shadow: 0 0 10px rgba(243, 156, 18, 0.5); }

        /* --- Bottom Nav --- */
        .nav-bar {
            position: fixed; bottom: 15px; left: 15px; right: 15px;
            background: rgba(30, 30, 30, 0.85); backdrop-filter: blur(20px);
            border-radius: 25px; border: 1px solid rgba(255,255,255,0.08);
            display: flex; justify-content: space-around;
            padding: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 500;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #888; font-size: 0.75rem; gap: 4px; padding: 5px 10px;
            border-radius: 15px; transition: 0.2s; width: 60px;
        }
        .nav-item.active { background: rgba(255,255,255,0.1); color: #fff; transform: translateY(-5px); }
        .nav-icon { font-size: 1.4rem; }

        /* --- Modals (Glassmorphism) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 900;
            opacity: 0; visibility: hidden; transition: 0.3s;
            backdrop-filter: blur(5px);
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        
        .modal-content {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: #1a1a1a;
            border-radius: 30px 30px 0 0;
            padding: 25px;
            transform: translateY(100%); transition: 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            max-height: 80vh; overflow-y: auto;
            border-top: 1px solid var(--border);
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
        }
        .modal-overlay.active .modal-content { transform: translateY(0); }

        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 1.4rem; font-weight: 800; color: #fff; }
        .close-btn { background: #333; border: none; width: 30px; height: 30px; border-radius: 50%; color: #fff; font-weight: bold; }

        /* --- Shop Items --- */
        .shop-item {
            background: rgba(255,255,255,0.05); padding: 15px; border-radius: 15px;
            margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between;
            border: 1px solid transparent; transition: 0.2s;
        }
        .shop-item:active { background: rgba(255,255,255,0.1); transform: scale(0.98); }
        .shop-icon { font-size: 1.8rem; margin-left: 15px; background: rgba(0,0,0,0.3); width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; }
        .shop-details h4 { margin: 0; font-size: 1rem; color: #fff; }
        .shop-details p { margin: 5px 0 0; font-size: 0.8rem; color: #aaa; }
        .shop-price { background: var(--primary); color: #fff; padding: 8px 15px; border-radius: 10px; font-weight: bold; font-size: 0.9rem; min-width: 80px; text-align: center; }
        .shop-price.disabled { background: #444; color: #888; }

        /* Loader */
        #loader { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; transition: opacity 0.5s; }
        .loader-ring { width: 50px; height: 50px; border: 4px solid #333; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div id="loader">
        <div class="loader-ring"></div>
        <h3 style="color:#fff; letter-spacing:2px">TON LEGEND</h3>
    </div>

    <div class="header">
        <div class="user-badge">
            <div class="avatar">üë§</div>
            <div class="rank-info">
                <span class="rank-name" id="rank-name">Bronze</span>
                <div class="rank-bar-bg"><div class="rank-bar-fill" id="rank-bar"></div></div>
            </div>
        </div>
        <button class="mini-btn" onclick="toggleLang()">
            <span id="lang-icon">üá∫üá∏</span> <span id="lang-text">EN</span>
        </button>
    </div>

    <div class="score-container">
        <div class="score-val" id="score">0</div>
        <div class="score-label" data-key="balance">Total Balance</div>
    </div>

    <div class="controls-row" style="margin-top: 20px;">
        <div class="mini-btn" onclick="openModal('daily')">
            <span>üìÖ</span> <span data-key="daily">Daily</span>
        </div>
        <div class="mini-btn" onclick="openModal('code')">
            <span>üéÅ</span> <span data-key="gift">Code</span>
        </div>
    </div>

    <div class="game-stage">
        <div class="coin-wrapper" id="coin" onpointerdown="handleTap(event)">
            <div class="coin-inner">
                <svg class="coin-logo" viewBox="0 0 24 24"><path d="M12 22L1.5 8 12 2l10.5 6L12 22zm0-2.5l8-10-8-5.5-8 5.5 8 10z"/></svg>
            </div>
        </div>
    </div>

    <div class="energy-container">
        <div class="energy-info">
            <span style="color:#f39c12">‚ö° <span data-key="energy">Energy</span></span>
            <span id="energy-txt">1000/1000</span>
        </div>
        <div class="energy-track"><div class="energy-fill" id="energy-bar"></div></div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="switchTab('game')">
            <span class="nav-icon">üéÆ</span>
            <span data-key="game_tab">Game</span>
        </div>
        <div class="nav-item" onclick="openModal('boost')">
            <span class="nav-icon">üöÄ</span>
            <span data-key="boost_tab">Boost</span>
        </div>
        <div class="nav-item" onclick="openModal('tasks')">
            <span class="nav-icon">üìã</span>
            <span data-key="tasks_tab">Tasks</span>
        </div>
        <div class="nav-item" onclick="openModal('quiz')">
            <span class="nav-icon">üß†</span>
            <span data-key="quiz_tab">Quiz</span>
        </div>
    </div>

    <div class="modal-overlay" id="boost">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title" data-key="boost_title">Boosters</span>
                <button class="close-btn" onclick="closeModal('boost')">‚úï</button>
            </div>
            
            <div class="shop-item" onclick="upgrade('multitap')">
                <div class="shop-icon">üëÜ</div>
                <div class="shop-details">
                    <h4 data-key="multitap">Multitap</h4>
                    <p id="multitap-lvl">Level 1</p>
                </div>
                <div class="shop-price" id="multitap-price">500</div>
            </div>

            <div class="shop-item" onclick="upgrade('limit')">
                <div class="shop-icon">üîã</div>
                <div class="shop-details">
                    <h4 data-key="energy_limit">Energy Limit</h4>
                    <p id="limit-lvl">Level 1</p>
                </div>
                <div class="shop-price" id="limit-price">1000</div>
            </div>

            <div class="shop-item" onclick="upgrade('speed')">
                <div class="shop-icon">‚ö°</div>
                <div class="shop-details">
                    <h4 data-key="recharge">Recharging Speed</h4>
                    <p id="speed-lvl">Level 1</p>
                </div>
                <div class="shop-price" id="speed-price">2000</div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="tasks">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title" data-key="tasks_title">Earn Tasks</span>
                <button class="close-btn" onclick="closeModal('tasks')">‚úï</button>
            </div>
            <div id="tasks-list">
                </div>
        </div>
    </div>

    <div class="modal-overlay" id="daily">
        <div class="modal-content" style="text-align:center">
            <h2 data-key="daily_reward">Daily Reward</h2>
            <div style="font-size:3rem; margin:20px 0">üéÅ</div>
            <p id="daily-msg" style="color:#aaa; margin-bottom:20px">Come back every day for rewards!</p>
            <button class="mini-btn" style="width:100%; justify-content:center; background:var(--primary); padding:15px;" onclick="claimDaily()" id="daily-btn">Claim</button>
        </div>
    </div>

    <div class="modal-overlay" id="quiz">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">Quiz Challenge</span>
                <button class="close-btn" onclick="closeModal('quiz')">‚úï</button>
            </div>
            <div id="quiz-container" style="text-align:center">
                <h1 id="q-icon" style="font-size:4rem; margin:10px 0">üåç</h1>
                <h3 id="q-txt">Question Text</h3>
                <div id="q-opts" style="display:grid; gap:10px; margin-top:20px"></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="code">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">Promo Code</span>
                <button class="close-btn" onclick="closeModal('code')">‚úï</button>
            </div>
            <input type="text" id="promo-input" placeholder="Enter Code..." style="width:100%; padding:15px; background:#222; border:1px solid #444; color:#fff; border-radius:12px; margin-bottom:15px;">
            <button class="mini-btn" style="width:100%; justify-content:center; background:var(--success)" onclick="redeemCode()">Submit</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.setHeaderColor('#1a3a5a');

        // --- Config & State ---
        const CONFIG = {
            baseEnergy: 1000,
            baseCost: { multitap: 500, limit: 1000, speed: 2000 }
        };

        let state = {
            score: parseInt(localStorage.getItem('tl_score') || 0),
            energy: parseInt(localStorage.getItem('tl_energy') || 1000),
            upgrades: JSON.parse(localStorage.getItem('tl_upgrades') || '{"multitap":1, "limit":1, "speed":1}'),
            lastLogin: localStorage.getItem('tl_lastLogin'),
            lang: localStorage.getItem('tl_lang') || 'ar',
            completedTasks: JSON.parse(localStorage.getItem('tl_tasks') || "[]")
        };

        const LANG = {
            ar: { 
                balance: "ÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑŸÉŸÑŸä", energy: "ÿßŸÑÿ∑ÿßŸÇÿ©", 
                game_tab: "ÿßŸÑŸÑÿπÿ®", boost_tab: "ÿ™ÿπÿ≤Ÿäÿ≤", tasks_tab: "ŸÖŸáÿßŸÖ", quiz_tab: "ŸÖÿ≥ÿßÿ®ŸÇÿ©",
                boost_title: "ŸÖÿ±ŸÉÿ≤ ÿßŸÑÿ™ÿπÿ≤Ÿäÿ≤", multitap: "ŸÜŸÇÿ±ÿ© ŸÖÿ™ÿπÿØÿØÿ©", energy_limit: "ÿ≥ÿπÿ© ÿßŸÑÿ∑ÿßŸÇÿ©", recharge: "ÿ≥ÿ±ÿπÿ© ÿßŸÑÿ¥ÿ≠ŸÜ",
                tasks_title: "ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸáÿßŸÖ", daily_reward: "ÿßŸÑŸÖŸÉÿßŸÅÿ£ÿ© ÿßŸÑŸäŸàŸÖŸäÿ©", gift: "ŸÉŸàÿØ", daily: "ŸäŸàŸÖŸä"
            },
            en: {
                balance: "Total Balance", energy: "Energy",
                game_tab: "Game", boost_tab: "Boost", tasks_tab: "Tasks", quiz_tab: "Quiz",
                boost_title: "Boost Center", multitap: "Multitap", energy_limit: "Energy Limit", recharge: "Recharge Speed",
                tasks_title: "Task List", daily_reward: "Daily Reward", gift: "Code", daily: "Daily"
            }
        };

        // --- Core Functions ---
        function init() {
            updateUI();
            updateUpgradesUI();
            applyLang(state.lang);
            animateCoinTilt();
            
            // Auto Recovery
            setInterval(() => {
                const max = CONFIG.baseEnergy * state.upgrades.limit;
                const rec = state.upgrades.speed;
                if(state.energy < max) {
                    state.energy = Math.min(state.energy + rec, max);
                    updateEnergyUI();
                }
            }, 1000);

            // Hide Loader
            setTimeout(() => document.getElementById('loader').style.opacity = 0, 1000);
            setTimeout(() => document.getElementById('loader').style.display = 'none', 1500);
        }

        function save() {
            localStorage.setItem('tl_score', state.score);
            localStorage.setItem('tl_upgrades', JSON.stringify(state.upgrades));
            localStorage.setItem('tl_tasks', JSON.stringify(state.completedTasks));
        }

        // --- Tap Logic ---
        function handleTap(e) {
            const tapPower = state.upgrades.multitap;
            
            if(state.energy >= tapPower) {
                // Logic
                state.score += tapPower;
                state.energy -= tapPower;
                save();
                updateUI();
                updateEnergyUI();
                
                // Haptic
                if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');

                // Float Number Effect
                spawnFloatText(e, `+${tapPower}`);
            }
        }

        // --- 3D Coin Effect ---
        function animateCoinTilt() {
            const coin = document.getElementById('coin');
            const container = document.querySelector('.game-stage');

            container.addEventListener('pointermove', (e) => {
                const rect = container.getBoundingClientRect();
                const x = e.clientX - rect.left - rect.width / 2;
                const y = e.clientY - rect.top - rect.height / 2;
                
                // Limit rotation
                const rotateX = -y / 10;
                const rotateY = x / 10;

                coin.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
            });

            container.addEventListener('pointerleave', () => {
                coin.style.transform = `rotateX(0) rotateY(0)`;
            });
        }

        function spawnFloatText(e, text) {
            const el = document.createElement('div');
            el.className = 'float-num';
            el.innerText = text;
            
            // Randomize position slightly
            const x = e.clientX + (Math.random() * 40 - 20);
            const y = e.clientY - 20;
            
            el.style.left = `${x}px`;
            el.style.top = `${y}px`;
            
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 800);
        }

        // --- Upgrade System ---
        function upgrade(type) {
            const level = state.upgrades[type];
            const cost = CONFIG.baseCost[type] * (2 ** (level - 1));

            if(state.score >= cost) {
                state.score -= cost;
                state.upgrades[type]++;
                save();
                updateUI();
                updateUpgradesUI();
                tg.showAlert("Upgrade Successful! üöÄ");
            } else {
                tg.showAlert("Not enough points! üí∏");
            }
        }

        // --- UI Updates ---
        function updateUI() {
            document.getElementById('score').innerText = state.score.toLocaleString();
            
            // Rank Logic
            let rank = "Bronze";
            let progress = 0;
            if(state.score < 5000) { progress = (state.score/5000)*100; }
            else if(state.score < 25000) { rank = "Silver"; progress = ((state.score-5000)/20000)*100; }
            else if(state.score < 100000) { rank = "Gold"; progress = ((state.score-25000)/75000)*100; }
            else { rank = "Diamond"; progress = 100; }
            
            document.getElementById('rank-name').innerText = rank;
            document.getElementById('rank-bar').style.width = `${progress}%`;
        }

        function updateEnergyUI() {
            const max = CONFIG.baseEnergy * state.upgrades.limit;
            document.getElementById('energy-txt').innerText = `${Math.floor(state.energy)} / ${max}`;
            document.getElementById('energy-bar').style.width = `${(state.energy/max)*100}%`;
        }

        function updateUpgradesUI() {
            const u = state.upgrades;
            // Multitap
            document.getElementById('multitap-lvl').innerText = `Lvl ${u.multitap} (+${u.multitap} tap)`;
            document.getElementById('multitap-price').innerText = (CONFIG.baseCost.multitap * (2**(u.multitap-1))).toLocaleString();
            
            // Limit
            document.getElementById('limit-lvl').innerText = `Lvl ${u.limit} (${1000*u.limit} energy)`;
            document.getElementById('limit-price').innerText = (CONFIG.baseCost.limit * (2**(u.limit-1))).toLocaleString();

            // Speed
            document.getElementById('speed-lvl').innerText = `Lvl ${u.speed} (+${u.speed}/sec)`;
            document.getElementById('speed-price').innerText = (CONFIG.baseCost.speed * (2**(u.speed-1))).toLocaleString();
        }

        // --- Features (Daily, Tasks, Quiz) ---
        function claimDaily() {
            const today = new Date().toDateString();
            if(state.lastLogin !== today) {
                state.score += 1000;
                state.lastLogin = today;
                localStorage.setItem('tl_lastLogin', today);
                save(); updateUI();
                closeModal('daily');
                tg.showAlert("+1000 Points!");
            } else {
                tg.showAlert("Come back tomorrow!");
            }
        }

        function redeemCode() {
            const code = document.getElementById('promo-input').value;
            if(code.toUpperCase() === "TON2024") {
                state.score += 5000;
                save(); updateUI();
                closeModal('code');
                tg.showAlert("+5000 Bonus!");
            } else {
                tg.showAlert("Invalid Code");
            }
        }

        // Language & Utils
        function toggleLang() {
            state.lang = state.lang === 'ar' ? 'en' : 'ar';
            localStorage.setItem('tl_lang', state.lang);
            applyLang(state.lang);
            location.reload(); // Simple reload to refresh text directions
        }

        function applyLang(l) {
            document.body.dir = l === 'ar' ? 'rtl' : 'ltr';
            document.getElementById('lang-text').innerText = l === 'ar' ? 'AR' : 'EN';
            document.querySelectorAll('[data-key]').forEach(el => {
                const k = el.getAttribute('data-key');
                if(LANG[l][k]) el.innerText = LANG[l][k];
            });
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function switchTab(t) { /* Just for visual tab switching if needed later */ }

        // Start
        window.onload = init;

    </script>
</body>
</html>
